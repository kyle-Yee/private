<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.statisticalanalysis.mapper.ActualissuanceLoansMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="actualissuanceLoansMap" type="com.dcits.govsbu.sd.taxbankplatform.statisticalanalysis.model.ActualissuanceLoansEntity">
	<result property="totalamount" column="totalamount" />
		<result property="microamount" column="microamount" />
		<result property="microquota" column="microquota" />
		<result property="totalquota" column="totalquota" />
		<result property="microquotachange" column="microquotachange" />
		<result property="totalquotachange" column="totalquotachange" />
		<result property="totalamountProportion" column="totalamountProportion" />
		<result property="microamountProportion" column="microamountProportion" />
		<result property="quotaProportion" column="quotaProportion" />
		<result property="microProportion" column="microProportion" />
	</resultMap>

	<!-- 银税互动，统计分析总表 -->
	<select id="actualissuanceLoansEntities" parameterType="map" resultMap="actualissuanceLoansMap" flushCache="true" useCache="true">

    select 
    count(la.la_id) , 
    count(rec.lar_id) as totalamount,<!-- 总数量 -->
     count(rec2.lar_id) as microamount,<!-- 小微企业合计 -->
    count(rec2.lar_credit_quota),
    count(final.laf_id),
    count(final2.laf_id),
   count(rec2.lar_id)  as microquota ,<!-- 小微企业合计金额 -->
   (10000-sum(aqqlyend.lae_credit_quota))as totalquota ,<!-- 总金额（含大中型企业） -->
   count(rec2.lar_id)  as microquotachange ,<!-- 小微企业合计  余额-->
   (10000-sum(aqqlyend2.lae_credit_quota))as totalquotachange,<!-- 总金额 余额 -->
    ifNull(ROUND(( count(rec.lar_id) /count(la.la_id) *100),2), 0) as  totalamountProportion ,
   ifNull(ROUND((count(rec2.lar_id)/count(rec.lar_id)*100),2), 0)as   microamountProportion,
   ifNull(ROUND((count(rec2.lar_id)/(10000-sum(aqqlyend.lae_credit_quota))*100),2),0) as quotaProportion,
   ifNull(ROUND((count(rec2.lar_id)/1000*100),2),0) as microProportion
   from tb_loan_apply  la   
   left join   tb_loan_approve_rec rec on la.la_id=rec.la_id and rec.las_id='DKZT03'
   left join   tb_loan_approve_rec  rec2 on la.la_id=rec2.la_id and rec2.las_id='DKZT03' and rec2.lar_credit_quota  &lt;  3000
   left join   tb_loan_apply_final final on final.la_id=la.la_id  
   left join   tb_loan_applyend aqqlyend on  aqqlyend.laf_id=final.laf_id 
   left  join tb_regions on tb_regions.region_id=final.region_id
   left join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
   left join   tb_loan_apply_final final2 on final2.la_id=la.la_id 
   and rec2.las_id=3 and rec2.lar_credit_quota <![CDATA[ < ]]> 3000 
   <if test="start != null and start != '' and end != null and end != ''">
    and  date_format(final2.createtime, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
   </if>
     <if test="start == null or start == '' or end == null or end == ''">
    and  date_format(final2.createtime, '%Y-%c-%d') between date_format(#{start2}, '%Y-%c-%d') and date_format(#{end2}, '%Y-%c-%d')
    </if>
      <if test="pcId!=null and pcId!=''">
		
		and ( tb_province_cities.pc_pid = #{pcId}   or  tb_province_cities.pc_id = #{pcId}
				or tb_province_cities.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )) 
		   
	 </if>
   left join   tb_loan_applyend aqqlyend2 on  aqqlyend2.laf_id=final2.laf_id 
 

   <where> 
       <if test="pcId2!=null and pcId2!=''">
		
		 ( tb_province_cities.pc_pid = #{pcId2}   or  tb_province_cities.pc_id = #{pcId2}
				or tb_province_cities.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId2} )) 
		   
	 </if>
    <if test="start2 != null and start2 != '' and end2 != null and end2 != ''">
     and   date_format(final.createtime, '%Y-%c-%d') between date_format(#{start2}, '%Y-%c-%d') and date_format(#{end2}, '%Y-%c-%d')
    </if>
         <if test="regionId!=null and regionId!=''">
			     and final.region_id=#{regionId}
			 </if>  
			
    </where> 
	</select>
   
    <!-- 获取不受查询条件限制数据 -->
    <select id="getStaticData_bef" parameterType="java.util.Map" resultMap="actualissuanceLoansMap" flushCache="true" useCache="true"> 
    	SELECT IFNULL(tem.planAll-tem2.sumAll,0) AS totalquotachange,
			 IFNULL(tem.planMic-tem2.sumMic,0) AS microquotachange,
			 IFNULL(FORMAT(tem2.sumMic/tem.planMic*100,2),0) AS microProportion,
			 IFNULL(tem.badNum,0) AS badNum,
			 IFNULL(tem.badSum,0) AS badSum,
			 IFNULL(FORMAT(tem.badRate/tem.totalRefreshed,2),0) AS badRate
		FROM 
		
		(
			SELECT SUM(dr.bad_num) badNum,SUM(dr.bad_sum) badSum,count(1) totalRefreshed,sum(dr.bad_rate) badRate,IFNULL(sum(dr.yearly_plan_sum),0) planAll,IFNULL(sum(dr.yearly_plan_micro_sum),0) planMic
			FROM tb_data_refresh dr
			left JOIN tb_organizations org ON org.org_id=dr.org_id
			WHERE org.pc_id IN(
				SELECT t.pc_id from tb_province_cities t 
		    	where t.pc_id = #{pc_id} or t.pc_pid  = #{pc_id} OR t.pc_pid in (SELECT r.pc_id FROM
		 		tb_province_cities r where r.pc_pid = #{pc_id})				
			) 
			AND dr.data_month = #{last_month}
		
		) tem,
		
		(
			SELECT IFNULL(SUM(appendAll.lae_credit_quota),0) sumAll,IFNULL(SUM(appendMic.lae_credit_quota),0) sumMic 
			FROM tb_loan_apply_final fin
				LEFT JOIN tb_loan_applyend appendAll ON fin.laf_id=appendAll.laf_id
				LEFT JOIN tb_loan_applyend appendMic ON fin.laf_id=appendMic.laf_id AND appendMic.lae_credit_quota <![CDATA[ < ]]> 3000
				LEFT JOIN tb_financial_product fp ON fp.fp_id=fin.fp_id
				LEFT JOIN tb_organizations org ON org.org_id=fp.org_id
      	  	WHERE org.pc_id IN(
					SELECT t.pc_id 
					from tb_province_cities t 
					where t.pc_id = #{pc_id} or t.pc_pid  = #{pc_id} OR t.pc_pid in 
					(SELECT r.pc_id FROM tb_province_cities r where r.pc_pid = #{pc_id})
				
			) 
			AND DATE_FORMAT(appendAll.createtime,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{data_start},'%Y-%c-%d') AND DATE_FORMAT(now(),'%Y-%c-%d')
			AND DATE_FORMAT(appendMic.createtime,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{data_start},'%Y-%c-%d') AND DATE_FORMAT(now(),'%Y-%c-%d')
		
		) tem2
    </select>
    
    
     <!-- 获取受查询条件限制数据 -->
    <select id="getDynamicData_bef" parameterType="java.util.Map" resultMap="actualissuanceLoansMap" flushCache="true" useCache="true">
    	SELECT 
			IFNULL(SUM(rec.lar_credit_quota),0) totalquota,COUNT(rec.la_id) totalamount,
			IFNULL(SUM(recMic.lar_credit_quota),0) microquota,COUNT(recMic.la_id) microamount
			,FORMAT(IFNULL(COUNT(recMic.la_id)/COUNT(rec.la_id)*100,0),2) AS microamountProportion
			,FORMAT(IFNULL(SUM(recMic.lar_credit_quota)/SUM(rec.lar_credit_quota)*100,0),2) AS quotaProportion
		FROM tb_loan_apply app 
			LEFT JOIN tb_loan_approve_rec rec ON rec.la_id=app.la_id AND rec.las_id='DKZT03'
			LEFT JOIN tb_loan_approve_rec recMic ON recMic.la_id=app.la_id AND recMic.las_id='DKZT03' AND recMic.lar_credit_quota <![CDATA[ < ]]> 3000
			LEFT JOIN tb_financial_product fp ON fp.fp_id=app.fp_id
			LEFT JOIN tb_organizations org ON org.org_id=fp.org_id
		WHERE 
			 org.pc_id IN
			 (
				SELECT t.pc_id from tb_province_cities t 
		    	where t.pc_id = #{pc_id} or t.pc_pid  = #{pc_id} OR t.pc_pid in (SELECT r.pc_id FROM
		 		tb_province_cities r where r.pc_pid = #{pc_id})				
			 ) 

    	<if test="starttime != null and endtime != null">
    		AND DATE_FORMAT(app.la_apply_time,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
    	</if>
    
    </select>
    
    <!-- 根据pc_id获取下辖的所有区pc_id -->
    <select id="getUnderArea" parameterType="java.util.Map" resultType="String">
    	SELECT t.pc_id from tb_province_cities t 
    	where t.pc_id = #{pc_id} or t.pc_pid  = #{pc_id} OR t.pc_pid in (SELECT r.pc_id FROM
 		tb_province_cities r where r.pc_pid = #{pc_id});
    </select>

	<!-- 获取不受查询条件限制数据 -->
    <select id="getStaticData" parameterType="java.util.Map" resultMap="actualissuanceLoansMap" flushCache="true" useCache="true"> 
    	<!-- SELECT IFNULL(tem.planAll-tem2.sumAll,0) AS totalquotachange,
			 IFNULL(tem.planMic-tem2.sumMic,0) AS microquotachange,
			 IFNULL(FORMAT(tem2.sumMic/tem.planMic*100,2),0) AS microProportion,
			 IFNULL(tem.badNum,0) AS badNum,
			 IFNULL(tem.badSum,0) AS badSum,
			 IFNULL(FORMAT(tem.badRate/tem.totalRefreshed,2),0) AS badRate
		FROM 
		
		(	
			SELECT SUM(dr.bad_num) badNum,SUM(dr.bad_sum) badSum,COUNT(1) totalRefreshed,SUM(dr.bad_rate) badRate,IFNULL(SUM(dr.yearly_plan_sum),0) planAll,IFNULL(SUM(dr.yearly_plan_micro_sum),0) planMic 
			FROM (SELECT (SELECT r.`region_code` FROM `tb_regions` r WHERE r.`region_id`= t.`region_id`) regioncode,t.* FROM tb_data_refresh t) dr
			<where>
				<if test="province !=null and province !='' and city==null">
					and SUBSTR(dr.regioncode,1,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and SUBSTR(dr.regioncode,1,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and SUBSTR(dr.regioncode,1,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and SUBSTR(dr.regioncode,1,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if> 
				AND dr.data_month = #{last_month}
			</where>
		) tem,
		
		(
			SELECT SUM(ye.`sumall`) sumAll,SUM(ye.`summic`) sumMic FROM `tb_statistics_actualloanye` ye
			<where>
				<if test="province !=null and province !='' and city==null">
					and ye.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and ye.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and ye.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and ye.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="data_start != null and data_start != ''">
					AND DATE_FORMAT(ye.`appendalldate`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{data_start},'%Y-%c-%d') AND DATE_FORMAT(now(),'%Y-%c-%d')
					AND DATE_FORMAT(ye.`appendmicdate`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{data_start},'%Y-%c-%d') AND DATE_FORMAT(now(),'%Y-%c-%d')
				</if>
			</where>
		) tem2 -->
		
		SELECT IFNULL(dkye,0)/10000 AS totalquotachange,
			 IFNULL(xw_dkye,0)/10000 AS microquotachange,
			 IFNULL(FORMAT(xw_dkye/dkye*100,2),0) AS microProportion,
			 IFNULL(badbs,0) AS badNum,
			 IFNULL(badje,0)/10000 AS badSum,
			 IFNULL(FORMAT(badbs/COUNT(DISTINCT y.GRANTCODE),2),0) AS badRate
		FROM(
		SELECT
			*
		FROM
			v_tb_loan_dhsx dhsx
			<where>
			    <if test="starttime != null and endtime != null">
	    	       AND DATE_FORMAT(dhsx.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	            </if>
			</where>
	) y
	LEFT JOIN 
	(
		SELECT
			sum(b.LOANBALANCE) dkye
		FROM
			v_tb_loan_dhsx b
		<where>
		<if test="starttime != null and endtime != null">
	    	AND DATE_FORMAT(b.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	    </if>
		</where>
	) w  ON 1 = 1
LEFT JOIN (
	SELECT
		sum(b.LOANBALANCE) xw_dkye
	FROM
		v_tb_loan_dhsx b
	WHERE b.ENTCREDITID IN (
		SELECT
			sxmd.ENTCREDITID
		FROM
			(
				SELECT
					SUM(dhsx.LOANAMOUNT) sxze,
					dhsx.ENTCREDITID
				FROM
					v_tb_loan_dhsx dhsx
				GROUP BY
					dhsx.ENTCREDITID
			) sxmd
		WHERE
			sxmd.sxze <![CDATA[ < ]]> 30000000
	)
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(B.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(B.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and B.`xzqhszdm` = #{area}
			</if>
	<if test="starttime != null and endtime != null">
	    AND DATE_FORMAT(b.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
) e ON 1 = 1
LEFT JOIN (
	SELECT
		COUNT(DISTINCT a.GRANTCODE) badbs,
		SUM(a.LOANAMOUNT) badje
	FROM
		v_tb_loan_dhsx a
	WHERE
		a.LOANOVERDUE = 'Y'
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and A.`xzqhszdm` = #{area}
			</if>
	<if test="starttime != null and endtime != null">
	    AND DATE_FORMAT(a.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
) t ON 1 = 1
    </select>
    
    <!-- 获取受查询条件限制数据 -->
    <select id="getDynamicData" parameterType="java.util.Map" resultMap="actualissuanceLoansMap" flushCache="true" useCache="true">
    	<!-- SELECT SUM(sx.`totalquota`) AS totalquota,SUM(sx.`totalamount`) AS totalamount, SUM(sx.`microquota`) AS microquota, SUM(sx.`microamount`) AS microamount,
		FORMAT(IFNULL(SUM(sx.`microquota`)/SUM(sx.`totalquota`)*100,0),2) AS microamountProportion,
		FORMAT(IFNULL(SUM(sx.`microamount`)/SUM(sx.`totalamount`)*100,0),2) AS quotaProportion
		FROM `tb_statistics_actualloansx` sx
		<where>
			<if test="province !=null and province !='' and city==null">
				and sx.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
				<if test="isChongQing != null and isChongQing == 'yes'">
	             and sx.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
	            <if test="isChongQing != null and isChongQing == 'no'">
	              and sx.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and sx.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
	    	<if test="starttime != null and endtime != null">
	    		AND DATE_FORMAT(sx.`la_apply_time`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	    	</if>
		</where>  -->
		
		SELECT
			IFNULL(a.sxze,0)/10000 totalquota,a.sxbs totalamount,
			IFNULL(b.xw_sxze,0)/10000 microquota,b.xw_sxbs microamount
			,FORMAT(IFNULL(b.xw_sxbs/a.sxbs*100,0),2) AS microamountProportion
			,FORMAT(IFNULL(b.xw_sxze/a.sxze*100,0),2) AS quotaProportion
	FROM
		(
			SELECT
				COUNT(DISTINCT dhsx.GRANTCODE) sxbs,
				SUM(dhsx.LOANAMOUNT) sxze
			FROM
				v_tb_loan_dhsx dhsx
			<where>	
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(dhsx.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(dhsx.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and dhsx.`xzqhszdm` = #{area}
			</if>
			    <if test="starttime != null and endtime != null">
	    	       AND DATE_FORMAT(dhsx.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	            </if>
			</where>
		) a
	LEFT JOIN (
		SELECT
			COUNT(DISTINCT dhsx.GRANTCODE) xw_sxbs,
			SUM(dhsx.LOANAMOUNT) xw_sxze
		FROM
			v_tb_loan_dhsx dhsx
		WHERE
			dhsx.ENTCREDITID IN (
				SELECT
					sxmd.ENTCREDITID
				FROM
					(
						SELECT
							SUM(dhsx.LOANAMOUNT) sxze,
							dhsx.ENTCREDITID
						FROM
							v_tb_loan_dhsx dhsx
						GROUP BY
							dhsx.ENTCREDITID
					) sxmd
				WHERE
					sxmd.sxze <![CDATA[ < ]]> 30000000
			)
		
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(dhsx.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(dhsx.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and dhsx.`xzqhszdm` = #{area}
			</if>
	    <if test="starttime != null and endtime != null">
	    	AND DATE_FORMAT(dhsx.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	    </if>
	) b ON 1 = 1
    </select>
</mapper>