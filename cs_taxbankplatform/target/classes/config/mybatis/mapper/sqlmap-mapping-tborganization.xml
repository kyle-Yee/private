<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.organization.mapper.OrganizationsMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	<!-- <cache type="org.mybatis.caches.ehcache.EhcacheCache"/> -->

	<sql id="orgAttributes">
		org_id,
		region_id,
		org_name,
		rc_id,
		ot_id,
		org_code,
		org_logo_url,
		remark,
		accredit,
		enabled,
		creatorid,
		createtime,
		updatorid,
		updatetime
	</sql>

	<resultMap id="orgMap" type="com.dcits.govsbu.sd.taxbankplatform.organization.model.OrganizationEntity">
		<id property="id" column="org_id"/>
		<result property="regionid" column="region_id"/>
		<result property="otid" column="ot_id"/>
		<result property="orgcode" column="org_code"/>
		<result property="orglogourl" column="org_logo_url"/>
		<result property="remark" column="remark"/>
		<result property="enabled" column="enabled"/>
		<result property="creatorid" column="creatorid"/>
		<result property="createtime" column="createtime"/>
		<result property="updatorid" column="updatorid"/>
		<result property="updatetime" column="updatetime"/>
		<result property="upOrgId" column="up_org_id"/>
		<result property="rcid" column="rc_id"/>
		<result property="pcid" column="pc_id"/>
		<result property="rzcid" column="rzc_id"/>
		<result property="sqcid" column="sqc_id"/>
		<result property="accredit" column="accredit"/>
		<association property="organizationsTypeEntity" column="id" javaType="com.dcits.govsbu.sd.taxbankplatform.organizationstype.model.OrganizationsTypeEntity" > 
			<result property="ot_name" column="ot_name"/>
		</association>
		<association property="regionsEntity" column="id" javaType="com.dcits.govsbu.sd.taxbankplatform.regions.model.RegionsEntity" > 
			<result property="regionname" column="region_name"/>
		</association>
		<association property="regionclassEntity" column="id" javaType="com.dcits.govsbu.sd.taxbankplatform.regionclass.model.RegionclassEntity" > 
			<result property="rcName" column="rc_name"/>
		</association>
		<association property="organizationEntity" column="id" javaType="com.dcits.govsbu.sd.taxbankplatform.organization.model.OrganizationEntity" > 
			<result property="upname" column="up_name"/>
		</association>
	</resultMap>
	
	<select id="queryListByPage" parameterType="map" resultMap="orgMap" flushCache="true" useCache="true">
		SELECT  org.org_id,
				org.region_id,
				reg.region_name,
				org.org_name,
				org.ot_id,
				ot.ot_name,
				org.org_code,
				org.org_logo_url,
				org.remark,
				org.enabled,
				org.creatorid,
				org.createtime,
				org.updatorid,
				org.updatetime,
				org.up_org_id,
				org.rc_id,
				rc.rc_name,
				orgs.org_name as up_name
				FROM tb_organizations org 
				LEFT JOIN tb_organizations_type ot on org.ot_id = ot.ot_id
				LEFT JOIN tb_regions reg on org.region_id = reg.region_id
				LEFT JOIN tb_region_class rc on org.rc_id = rc.rc_id
				LEFT JOIN tb_organizations orgs ON org.up_org_id = orgs.org_id
			<where>
				<if test="orgname != null and orgname != ''">
				org.org_name like CONCAT('%',#{orgname},'%')
				</if>
				<if test="orgCode != null and orgCode != ''">
				and org.org_code =#{orgCode}
				</if>
				<if test="orgName!= null and orgName!= ''">
				and org.org_name =#{orgName}
				</if>
				<if test="regionId!= null and regionId!= ''">
				and org.region_id =#{regionId}
				</if>
			</where>
	</select>
	
	<select id="findById" parameterType="String" resultMap="orgMap" flushCache="true" useCache="true">
		SELECT  org.org_id,
				org.region_id,
				reg.region_name,
				org.org_name,
				org.ot_id,
				ot.ot_name,
				org.org_code,
				org.org_logo_url,
				org.remark,
				org.enabled,
				org.creatorid,
				org.createtime,
				org.updatorid,
				org.updatetime,
				org.up_org_id,
				org.rc_id,
				org.pc_id,
				org.rzc_id,
				org.sqc_id,
				org.accredit
				FROM tb_organizations org 
				LEFT JOIN tb_organizations_type ot on org.ot_id = ot.ot_id
				LEFT JOIN tb_regions reg on org.region_id = reg.region_id
	    where org.org_id = #{id}
	</select>
	
	
	<select id="queryListAll" parameterType="map" resultMap="orgMap" flushCache="true" useCache="true" >
		SELECT  org_id,
				region_id,
				org_name,
				ot_id,
				org_code,
				org_logo_url,
				remark,
				enabled,
				creatorid,
				createtime,
				updatorid,
				updatetime,
				up_org_id,
				rc_id,
				pc_id,
				accredit
				FROM tb_organizations
		<where>
				enabled='Y'
			<if test="regionid!=null and regionid !=''">
				and region_id = #{regionid}
			</if>
			<if test="orgid!=null and orgid !=''">
				and org_id = #{orgid}
			</if>
			<if test="otid!=null and otid !=''">
				and ot_id = #{otid}
			</if>
			<if test="orgcode!=null and orgcode !=''">
				and org_code = #{orgcode}
			</if>
		</where>
		ORDER BY region_id,org_id
	</select>
	
	
	<insert id="insert" parameterType="com.dcits.govsbu.sd.taxbankplatform.organization.model.OrganizationEntity" useGeneratedKeys="true" keyProperty="id">
		insert ignore into tb_organizations (
				org_id,
				region_id,
				org_name,
				ot_id,
				org_code,
				org_logo_url,
				remark,
				enabled,
				creatorid,
				createtime,
				updatorid,
				updatetime,
				up_org_id,
				rc_id,
				rzc_id,
				sqc_id,
				accredit,
				pc_id
			)   
		values (
				#{id},
				#{regionid},
				#{orgname},
				#{otid},
				#{orgcode},
				#{orglogourl},
				#{remark},
				#{enabled},
				#{creatorid},
				#{createtime},
				#{updatorid},
				#{updatetime},
				#{upOrgId},
				#{rcid},
				#{rzcid},
				#{sqcid},
				#{accredit},
				#{pcid}
			)  
	</insert>
	
	<update id="update" parameterType="com.dcits.govsbu.sd.taxbankplatform.organization.model.OrganizationEntity" flushCache="true">
		update tb_organizations
	    <set >
	     <!--  <if test="regionid != null" >
	        region_id = #{regionid},
	      </if> -->
	      <if test="orgname != null" >
	        org_name = #{orgname},
	      </if>
	     <!--  <if test="otid != null and otid!=''" >
	        ot_id = #{otid},
	      </if> -->
	      <if test="orgcode != null" >
	        org_code = #{orgcode},
	      </if>
	      <if test="orglogourl != null" >
	        org_logo_url = #{orglogourl},
	      </if>
	      <if test="remark != null" >
	        remark = #{remark},
	      </if>
	       <if test="enabled != null" >
	        enabled = #{enabled},
	      </if>
	      <if test="creatorid != null" >
	        creatorid = #{creatorid},
	      </if>
	      <if test="createtime != null" >
	        createtime = #{createtime},
	      </if>
	      <if test="updatorid != null" >
	        updatorid = #{updatorid},
	      </if>
	      <if test="updatetime != null" >
	        updatetime =  now(),
	      </if>
	      <if test="upOrgId != null" >
	        up_org_id = #{upOrgId},
	      </if>
	      <if test="rcid != null" >
	        rc_id = #{rcid},
	      </if>
	      <if test="pcid != null" >
	        pc_id = #{pcid},
	      </if>
	       <if test="accredit != null" >
	        accredit = #{accredit}
	      </if>
	      
	      <if test="rzcid != null" >
	        rzc_id = #{rzcid},
	      </if>
	       <if test="sqcid != null" >
	        sqc_id = #{sqcid}
	      </if>
	      
	    </set>
	    where org_id = #{id}
	</update>
	
	<delete id="deleteBatchById" parameterType="list">
		<![CDATA[  
       delete from tb_organizations where org_id in  
    	]]>  
	    <foreach collection="list" item = "id" open="(" separator="," close=")">
	    #{id}  
	    </foreach>  
	</delete>
	
	<select id="queryUpOrgIdListAll" parameterType="map" resultMap="orgMap" flushCache="true" useCache="true" >
		SELECT  org_id,
				region_id,
				org_name,
				ot_id,
				org_code,
				org_logo_url,
				remark,
				enabled,
				creatorid,
				createtime,
				updatorid,
				updatetime,
				up_org_id,
				rc_id,
				accredit,
				pc_id
				FROM tb_organizations
				WHERE
				ot_id = #{otid}
				and rc_id = #{rcid}
				ORDER BY region_id,org_id,pc_id
	</select>
	<!-- 查询已区域机关组织 -->
	 <resultMap id="BaseResultMap" type="com.dcits.govsbu.sd.taxbankplatform.taxauthority.model.TaxAuthorityEntity" >
	    <id column="tax_id" property="id" />
	    <result column="tax_name" property="taxName" />
	    <result column="tax_prc_id" property="taxPrcId" />
	    <result column="tax_is" property="taxIs" />
	    <result column="enabled" property="enabled" />
  	</resultMap>
	<select id="findTaxAuthorityListById" resultMap="BaseResultMap" >
		SELECT tc.tax_id,
		tc.tax_name 
		FROM tb_organizations_authority_compare ta 
		LEFT JOIN tb_tax_authority_code  tc ON 
		ta.tax_id = tc.tax_id 
		where ta.org_id = #{orgid}
		ORDER BY tc.tax_id
	</select>
	<!-- 查询认证授权协议类型 -->
	 <resultMap id="rzxyMap" type="com.dcits.govsbu.sd.taxbankplatform.organization.model.RzxyEntity" >
	    <id column="rzc_id" property="id" />
	    <result column="rzc_name" property="rzcname" />
	    <result column="rzc_code" property="rzccode" />
	    <result column="enabled" property="enabled" />
  	</resultMap>
	<select id="findrzxy" resultMap="rzxyMap" >
		select  rzc_id,  rzc_name, rzc_code,enabled from tb_rzxy_code where enabled='Y'
	</select>
	<!-- 查询税务授权协议类型 -->
	 <resultMap id="sqxyMap" type="com.dcits.govsbu.sd.taxbankplatform.organization.model.SqxyEntity" >
	    <id column="sqc_id" property="id" />
	    <result column="sqc_name" property="sqcname" />
	    <result column="sqc_code" property="sqccode" />
	    <result column="enabled" property="enabled" />
  	</resultMap>
	<select id="findsqxy" resultMap="sqxyMap" >
		select  sqc_id,  sqc_name, sqc_code,enabled from tb_sqxy_code where enabled='Y'
	</select>
</mapper>