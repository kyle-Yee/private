<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.taxpdf.mapper.TaxPdfBggsMapper" >
<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
  <resultMap id="BaseResultMap" type="com.dcits.govsbu.sd.taxbankplatform.taxpdf.model.TaxPdfBggsEntity" >
				
		<result property="ml" column="ml"/>
		<result property="dl" column="dl"/>
		<result property="zl" column="zl"/>
		<result property="xl" column="xl"/>
		<association property="taxBggsEntity" javaType="com.dcits.govsbu.sd.taxbankplatform.taxpdf.model.TaxBggsEntity">
			<result property="qymc" column="nsryhxx_qymc"/>
			<result property="fddbrxm" column="tth_fddbrxm" />
			<result property="zczb" column="tthk_zczb"/>
			<result property="zzjgkxdm" column="tthk_zzjgkx_dm"/>
			<result property="dj" column="ttn_dj"/>
			<result property="hydm" column="tth_hy_dm"/>
			<result property="djzclxDm" column="tth_djzclx_dm"/>
			<result property="djrq" column="tth_djrq"/>
			<result property="nsrsbh" column="tth_nsrsbh"/>
			<result property="znsed" column="st_znsed"/>
		</association>
  </resultMap>
  <!-- 查询报告概述 -->
  <select id="findByDjxh" parameterType="map" resultMap="BaseResultMap" flushCache="true" useCache="true" >
  	SELECT 
  		tnx.nsryhxx_qymc,
  		ttq.tth_fddbrxm, 
  		ttqk.tthk_zczb,
  		ttqk.tthk_zzjgkx_dm,
  		ttn.ttn_dj,
  		ttq.tth_hy_dm,
  		ttq.tth_djzclx_dm,
  		ttq.tth_djrq,
  		ttq.tth_nsrsbh,
  		djzclx.djzclxmc
		FROM tb_nsryhxx tnx
	LEFT JOIN t_tax_qyjcxx ttq ON tnx.nsryhxx_nsrsbh = ttq.tth_nsrsbh
	LEFT JOIN t_tax_qyjcxx_kz ttqk ON ttq.djxh = ttqk.djxh
	LEFT JOIN t_djzclx_dm  djzclx ON ttq.tth_djzclx_dm=djzclx.djclx_dm
	LEFT JOIN t_tax_nsrxydj ttn ON ttqk.djxh= ttn.djxh where tnx.creatorid = #{userid} and ttq.sqxh = #{sqxh} order by ttq.createtime desc
   </select>
   <!-- 查询近两年的总纳税额度 -->
   <select id="findZnsed" parameterType="String" statementType="CALLABLE" resultType="Decimal" >
   		{call sp_znsed(#{sqxh})}
   </select>
   <!-- 根据行业代码找到企业的行业信息 -->
   <select id="findHyxx" parameterType="java.lang.String"  resultMap="BaseResultMap" flushCache="true" useCache="true">
   		SELECT td.hy_mc as ml,tm.hy_mc as dl ,ty.hy_mc as zl,th.hy_mc as xl
		FROM tb_hydm th
		JOIN tb_hydm ty ON ty.hy_sjhydm = th.hy_dm
		JOIN tb_hydm tm ON tm.hy_sjhydm = ty.hy_dm
		JOIN tb_hydm td ON td.hy_sjhydm = tm.hy_dm
		WHERE td.hy_dm = #{hydm};
   </select>
      <!-- 根据申请id找到纳税人的用户id -->
   <select id="findUserIdById" parameterType="String"  resultType="String" flushCache="true" useCache="true">
   		SELECT creatorid FROM tb_loan_apply
		WHERE la_id = #{id};
   </select>
   	<!-- 获取湖南接口最新批次数据的申请序号 -->
	<select id="findHNSqxh" resultType="String" flushCache="true" useCache="true">
		SELECT SUBSTRING_INDEX(GROUP_CONCAT(sqxh
		ORDER BY createtime DESC), ',', 1 ) sqxh FROM t_tax_qyjcxx
	</select>
</mapper>