<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.mapper.IndustriesstatisticsMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="Industriesdetails" type="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.model.IndustriesdetailsEntity">
		<result property="hydm" column="hydm" />
		<result property="hymc" column="hymc" />
		<result property="mlbz" column="mlbz" />
		<result property="dlbz" column="dlbz" />
		<result property="zlbz" column="zlbz" />
		<result property="xlbz" column="xlbz" />
		<result property="sjhydm" column="sjhydm" />
		<result property="dksqbs" column="dksqbs" />
		<result property="dksqze" column="dksqze" />
		<result property="pjsdje" column="pjsdje" />
		<result property="cgsxbs" column="cgsxbs" />
		<result property="cgsxed" column="cgsxed" />
		<result property="pjsxed" column="pjsxed" />
	</resultMap>
	<!--按行业大类取值查询企业贷款业务明细  -->
	<!-- <select id="Industriesstatistics" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
			ifnull((sum(la.la_amount))/(count(la.la_id)),0) pjsdje,
			ifnull(count(temp2.lar_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(temp2.lar_id)),0) pjsxed
			
		from  
			tb_nsryhxx nx 
			join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
			join tb_loan_apply la on la.nsrsbh=nx.nsryhxx_nsrsbh
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
			left join (select 
						tb_loan_approve_rec.lar_id,
						tb_loan_approve_rec.region_id,
						tb_loan_approve_rec.fp_id,
						tb_loan_approve_rec.la_id,
						tb_loan_approve_rec.las_id,
						tb_loan_approve_rec.lar_credit_quota,
						tb_loan_approve_rec.lar_loan_deadline,
						tb_loan_approve_rec.lar_rate,
						tb_loan_approve_rec.updatetime,
						tb_loan_approve_rec.lar_bank_name
					from 
						tb_loan_approve_rec
						join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id		
						join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
						join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
					where
						tb_loan_approve_rec.las_id =3) temp2
			on temp2.la_id=la.la_id
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(temp2.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
			join tb_regions on tb_regions.region_id=n.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
		<where>
			<if test="pcId !=null and pcId !='' ">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in (
						select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 	
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
		    
		</where>
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where>
	</select> -->
	<!-- modify by xiecui 2018/04/02 begin -->
	<select id="Industriesstatistics_dat" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(distinct la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
	    ifnull((sum(la.la_amount))/(count(distinct la.la_id)),0) pjsdje,
			ifnull(count(distinct temp2.la_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(distinct temp2.la_id)),0) pjsxed
		from  
			tb_nsryhxx nx 
		left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
		left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
        join tb_loan_apply la on ((la.nsrsbh=nx.nsryhxx_nsrsbh and la.nsrsbh!='') or (nx.nsryhxx_shtyxydm = la.nsrsbh and la.nsrsbh!='')) and n.enabled='Y'
		left join (
		select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and ((ta.nsrsbh=nsrxx.nsryhxx_nsrsbh and ta.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = ta.nsrsbh and ta.nsrsbh!=''))
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		) temp2
			on la.la_id=temp2.la_id
		<if test="province !=null and province !='' and city==null and area==null">
			where substring(nx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where substring(nx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where substring(nx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where substring(nx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			<!-- and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
			and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<!-- <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and  date_format(lar.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if> 
		<where>
			<if test="pcId !=null and pcId !='' ">
				and (pc.pc_id = #{pcId} 
					or pc.pc_pid = #{pcId}
					or pc.pc_pid in (
						select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 	
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
		    
		</where>-->
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where>
		
		<!-- select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
	    ifnull((sum(la.la_amount))/(count(la.la_id)),0) pjsdje,
			ifnull(count(temp2.la_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(temp2.la_id)),0) pjsxed
		from  
			tb_nsryhxx nx 
			join tb_nsryh n on n.nsryh_id=nx.creatorid
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
			join tb_loan_apply la on la.creatorid=n.nsryh_id
			left join (select 
						tb_loan_approve_rec.lar_id,
						tb_loan_approve_rec.region_id,
						tb_loan_approve_rec.fp_id,
						tb_loan_approve_rec.la_id,
						tb_loan_approve_rec.las_id,
						tb_loan_approve_rec.lar_credit_quota,
						tb_loan_approve_rec.lar_loan_deadline,
						tb_loan_approve_rec.lar_rate,
						tb_loan_approve_rec.updatetime,
						tb_loan_approve_rec.lar_bank_name
					from 
						tb_loan_approve_rec
						join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id		
						join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
						join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
					where
						tb_loan_approve_rec.las_id =3) temp2
			on temp2.la_id=la.la_id
		<if test="province !=null and province !='' and city==null and area==null">
			where substring(nx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where substring(nx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where substring(nx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where substring(nx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and  date_format(lar.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if> 
		<where>
			<if test="pcId !=null and pcId !='' ">
				and (pc.pc_id = #{pcId} 
					or pc.pc_pid = #{pcId}
					or pc.pc_pid in (
						select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 	
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
		    
		</where>
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where> -->
	</select>
	
	<select id="Industriesstatistics_bef" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select max(t.hymc) hymc,sum(t.dksqbs) dksqbs, sum(t.dksqze) dksqze, sum(t.pjsdje) pjsdje, sum(t.cgsxbs) cgsxbs, sum(t.cgsxed) cgsxed, sum(t.pjsxed) pjsxed from
		(select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(distinct la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
	    ifnull((sum(la.la_amount))/(count(distinct la.la_id)),0) pjsdje,
			ifnull(count(distinct temp2.la_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(distinct temp2.la_id)),0) pjsxed
		from  
			tb_nsryhxx nx 
		left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
		left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
        join tb_loan_apply la on ((la.nsrsbh=nx.nsryhxx_nsrsbh and la.nsrsbh!='') or (nx.nsryhxx_shtyxydm = la.nsrsbh and la.nsrsbh!='')) and n.enabled='Y'
		left join (
		select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		
		union all
		
		select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		) temp2
			on la.la_id=temp2.la_id
		<if test="province !=null and province !='' and city==null and area==null">
			where substring(nx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where substring(nx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where substring(nx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where substring(nx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where>
		
		union all
		
		select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(distinct la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
	    ifnull((sum(la.la_amount))/(count(distinct la.la_id)),0) pjsdje,
			ifnull(count(distinct temp2.la_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(distinct temp2.la_id)),0) pjsxed
		from  
			tb_nsryhxx nx 
		left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
		left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
        join tb_loan_apply la on nx.nsryhxx_shtyxydm = la.nsrsbh  and n.enabled='Y'
		left join (
		select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		
		union all
		select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		) temp2
			on la.la_id=temp2.la_id
		<if test="province !=null and province !='' and city==null and area==null">
			where substring(nx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where substring(nx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where substring(nx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where substring(nx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where>)t
		group by t.hymc
	</select>	
	<!-- modify by xiecui 2018/04/02 end -->
	
	
	<!-- 按行业门类取值查询贷款业务明细 -->
	<!-- <select id="IndustriesstatisticsByMl" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select *
		from (select  
			case h.hy_mlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_mlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_mlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
			ifnull((sum(la.la_amount))/(count(la.la_id)),0) pjsdje,
			ifnull(count(temp2.lar_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(temp2.lar_id)),0) pjsxed
			
		from  
			tb_nsryhxx nx 
			join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
			join tb_loan_apply la on la.nsrsbh=nx.nsryhxx_nsrsbh
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
			left join (select 
						tb_loan_approve_rec.lar_id,
						tb_loan_approve_rec.region_id,
						tb_loan_approve_rec.fp_id,
						tb_loan_approve_rec.la_id,
						tb_loan_approve_rec.las_id,
						tb_loan_approve_rec.lar_credit_quota,
						tb_loan_approve_rec.lar_loan_deadline,
						tb_loan_approve_rec.lar_rate,
						tb_loan_approve_rec.updatetime,
						tb_loan_approve_rec.lar_bank_name
					from 
						tb_loan_approve_rec
						join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id		
						join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
						join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
					where
						tb_loan_approve_rec.las_id =3) temp2
			on temp2.la_id=la.la_id
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(temp2.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
			join tb_regions on tb_regions.region_id=n.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
		<where>
			<if test="pcId !=null and pcId !='' ">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in (
						select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 	
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
		    
		</where>
		group by hymc) e
		<where>
			<if test="sjhymc !=null and sjhymc !='' " >
		    	e.hymc = #{sjhymc}
		    </if>
		</where>
	</select> -->
	<!-- modify by xiecui 2018/04/02 begin -->
	
	<select id="IndustriesstatisticsByMl_dat" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
	    ifnull((sum(la.la_amount))/(count(la.la_id)),0) pjsdje,
			ifnull(count(temp2.la_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(temp2.la_id)),0) pjsxed
		from  
			tb_nsryhxx nx 
			join tb_nsryh n on n.nsryh_id=nx.creatorid
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
			join tb_loan_apply la on la.creatorid=n.nsryh_id
			left join (select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and ((ta.nsrsbh=nsrxx.nsryhxx_nsrsbh and ta.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = ta.nsrsbh and ta.nsrsbh!=''))
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id) temp2
			on la.la_id=temp2.la_id
		<if test="province !=null and province !='' and city==null and area==null">
			where substring(nx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where substring(nx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where substring(nx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where substring(nx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			<!-- and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
			and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<!-- <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and  date_format(lar.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if> 
		<where>
			<if test="pcId !=null and pcId !='' ">
				and (pc.pc_id = #{pcId} 
					or pc.pc_pid = #{pcId}
					or pc.pc_pid in (
						select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 	
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
		    
		</where>-->
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where>
	</select>
	
	<select id="IndustriesstatisticsByMl_bef" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select *
		from (select  
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm) 
			end hymc,
			ifnull(count(la.la_id),0) dksqbs,
			ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
	    ifnull((sum(la.la_amount))/(count(la.la_id)),0) pjsdje,
			ifnull(count(temp2.la_id),0) cgsxbs,
			ROUND(ifnull(sum(temp2.lar_credit_quota),0) , 2) cgsxed,
			ifnull((sum(temp2.lar_credit_quota))/(count(temp2.la_id)),0) pjsxed
		from  
			tb_nsryhxx nx 
			join tb_nsryh n on n.nsryh_id=nx.creatorid
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
			join tb_loan_apply la on la.creatorid=n.nsryh_id
			left join (select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		union all
		
		select tar.la_id,tar.lar_credit_quota
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh
		and nsr.enabled='Y' and tar.las_id ='DKZT03' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="province !=null and province !='' and city==null and area==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(nsrxx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		group by tar.lar_id
		) temp2
			on la.la_id=temp2.la_id
		<if test="province !=null and province !='' and city==null and area==null">
			where substring(nx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where substring(nx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where substring(nx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where substring(nx.nsryhxx_swjgdm,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by hymc) e
		<where>
			<if test="hymc !=null and hymc !='' " >
		    	e.hymc = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	isnull(e.hymc)
		    </if> 
		</where>
	</select>
	<!-- modify by xiecui 2018/04/02 end -->
	<!--全部合作企业的行业信息 -->
	<select id="searchIndustries"  resultMap="Industriesdetails" flushCache="true" useCache="true">
		select hy_dm,hy_mc from tb_hydm where hy_dlbz = 'Y'
		union 
		all select "9999","其他"
		<!-- select 
			distinct case h1.hy_dlbz
			when 'Y' then h1.hy_mc 
			when 'N' then 
				(select 
					case h2.hy_dlbz 
					when 'Y' then  h2.hy_mc
					when 'N' then (
						select  
							case h3.hy_dlbz
							when 'Y' then  h3.hy_mc
							when 'N' then (
								select  
									h4.hy_mc
								from 
									tb_hydm h4 
								where 
									h4.hy_dm=h3.hy_sjhydm
						)
						end
						from 
							tb_hydm h3 
						where 
							h3.hy_dm=h2.hy_sjhydm
					)
				 end
				 from 
				 	tb_hydm h2 
				 where 
				 	h2.hy_dm= h1.hy_sjhydm
				 ) 
		end hymc,
		ifnull(case h1.hy_dlbz
		when 'Y' then h1.hydm
		when 'N' then (select 
					case h2.hy_dlbz 
					when 'Y' then  h2.hy_dm
					when 'N' then (
						select  
							case h3.hy_dlbz
							when 'Y' then  h3.hy_dm
							when 'N' then (
								select  
									h4.hy_dm
								from 
									tb_hydm h4 
								where 
									h4.hy_dm=h3.hy_sjhydm
						)
						end
						from 
							tb_hydm h3 
						where 
							h3.hy_dm=h2.hy_sjhydm
					)
				 end
				 from 
				 	tb_hydm h2 
				 where 
				 	h2.hy_dm= h1.hy_sjhydm
				 ) 
		end,0) hydm
		from 
			(select  
				max(nx.nsryhxx_hydm) hydm,
				h.hy_mc ,
				h.hy_mlbz ,
				h.hy_dlbz,
				h.hy_zlbz ,
				h.hy_xlbz ,
				h.hy_sjhydm 
			from  
				tb_nsryhxx nx 
				join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
				left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm 
			group by nx.nsryhxx_nsrsbh) h1	 -->
	</select>
	
	<!--根据行业代码查询行业信息  -->
	<select id="queryByHydm" parameterType="string" resultMap="Industriesdetails" flushCache="true" useCache="true">
		select 
			hy.hy_dm hydm,
			hy.hy_mc hymc,
			hy.hy_mlbz mlbz,
			hy.hy_dlbz dlbz,
			hy.hy_zlbz zlbz,
			hy.hy_xlbz xlbz,
			hy.hy_sjhydm sjhydm
			 
		from 
			tb_hydm hy
			
		where 
			hy.hy_dm = #{hydm}
	</select>

	<select id="Industriesstatistics" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		SELECT loandetail.`hymc_dl` hymc,COUNT(loandetail.`la_id`) dksqbs,
		IFNULL(SUM(loandetail.`sdje`),0) dksqze,
		IFNULL(ROUND((SUM(loandetail.`sdje`))/(COUNT(loandetail.`la_id`)),2),0) pjsdje,
		COUNT(CASE WHEN loandetail.`sxje` IS NOT NULL THEN loandetail.`la_id` ELSE NULL END) cgsxbs,
		IFNULL(SUM(loandetail.`sxje`),0) cgsxed,
		IFNULL(ROUND((SUM(loandetail.`sxje`))/(COUNT(CASE WHEN loandetail.`sxje` IS NOT NULL THEN loandetail.`la_id` ELSE NULL END)),2),0) pjsxed
		FROM `tb_statistics_loandetail` loandetail

		<if test="province !=null and province !='' and city==null and area==null">
			where loandetail.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where loandetail.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where loandetail.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where loandetail.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(loandetail.`sdrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
			<if test="hymc !=null and hymc !='' " >
		    	and loandetail.`hymc_dl` = #{hymc}
		    </if>
		    <if test="hydm == '00'">
		    	and isnull(loandetail.`hymc_dl`)
		    </if>
		GROUP BY loandetail.`hydm_dl`
	</select>
	
	<select id="IndustriesstatisticsByMl" parameterType="map" resultMap="Industriesdetails" flushCache="true" useCache="true">
		SELECT loandetail.`hymc_ml` hymc,COUNT(loandetail.`la_id`) dksqbs,
		IFNULL(SUM(loandetail.`sdje`),0) dksqze,
		IFNULL(ROUND((SUM(loandetail.`sdje`))/(COUNT(loandetail.`la_id`)),2),0) pjsdje,
		COUNT(CASE WHEN loandetail.`sxje` IS NOT NULL THEN loandetail.`la_id` ELSE NULL END) cgsxbs,
		IFNULL(SUM(loandetail.`sxje`),0) cgsxed,
		IFNULL(ROUND((SUM(loandetail.`sxje`))/(COUNT(CASE WHEN loandetail.`sxje` IS NOT NULL THEN loandetail.`la_id` ELSE NULL END)),2),0) pjsxed
		FROM `tb_statistics_loandetail` loandetail
		<if test="province !=null and province !='' and city==null and area==null">
			where loandetail.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  where loandetail.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  where loandetail.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where loandetail.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and unix_timestamp(DATE_FORMAT(loandetail.`sdrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		<if test="sjhymc !=null and sjhymc !='' " >
	    	and loandetail.`hymc_ml` = #{sjhymc}
	    </if>
	    <if test="hydm == '00'">
	    	and isnull(loandetail.`hymc_ml`)
	    </if> 
		    
		GROUP BY loandetail.`hydm_ml`
	</select>

	<select id="industriesstatistics" parameterType="map" resultType="map" flushCache="true" useCache="true">
		SELECT IFNULL(sq.hy_dm, '9999') hydm,
			   IFNULL(sq.hy_mc, '其他') hymc,
			   COUNT(1) dksqbs,
			   round(IFNULL(SUM(sq.LOANAPPLYAMOUNT), 0) / 10000) dksqze,
			   round(IFNULL(SUM(sq.LOANAPPLYAMOUNT), 0) / 10000)/COUNT(1) pjsdje,
			   SUM(IF(sq.ADMITTANCE='0',1,0)) cgsxbs,
			   round(ifnull(SUM(sq.LOANAMOUNT), 0) / 10000) cgsxed,
			   round(IFNULL(SUM(sq.LOANAMOUNT), 0) / 10000)/SUM(IF(sq.ADMITTANCE='0',1,0)) pjsxed
		  FROM (SELECT *FROM tb_hydm a LEFT JOIN fact_dkxx b ON a.hy_dm = b.hydm UNION SELECT * FROM tb_hydm a RIGHT JOIN fact_dkxx b ON a.hy_dm = b.hydm ) sq
		 WHERE 1 = 1
		<if test="starttime != null and starttime != '' ">
			and unix_timestamp(sq.APPLYTIME) >= UNIX_TIMESTAMP(#{starttime})
		</if>
		<if test="endtime != null and endtime != '' ">
			AND unix_timestamp(sq.APPLYTIME) <![CDATA[ <= ]]> UNIX_TIMESTAMP(#{endtime})
		</if>
		<if test="pcId != null and pcId != '' ">
			and sq.xzqhszdm like concat(#{pcId}, '%')
		</if>
		<if test="hydmml != null and hydmml != ''">
			and sq.hy_mldm = #{hydmml}
		</if>
		<if test="hydmdl != null and hydmdl != ''">
			and sq.hy_dldm = #{hydmdl}
		</if>
		<if test="hydmzl != null and hydmzl != ''">
			and sq.hy_zldm = #{hydmzl}
		</if>
		 GROUP BY sq.hy_dm
		 ORDER  BY IFNULL(sq.hy_dm, '9999')
	</select>
	<select id="searchALlIndustries"  resultType="map" flushCache="true" useCache="true">
		select * from tb_hydm
	</select>
	
</mapper>