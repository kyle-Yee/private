<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.mapper.AreastatisticsMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志  -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="areastatisticsMap" type="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.model.BanklistInfoEntity">
		<result property="areaName" column="areaname" />
		<result property="zcyh" column="zcyh" />
		<result property="rzyh" column="rzyh" />
		<result property="dksqbs" column="sqdk" />
		<result property="cgsxbs" column="sxbs" />
		<result property="cgsxed" column="sxze" />
	</resultMap>
	
	<!-- <select id="areastatistics" parameterType="map" resultMap="areastatisticsMap" flushCache="true" useCache="true">
		select 
			max(pc.pc_name) areaname,
			ifnull(count(distinct n.nsryh_id),0) zcyh,
			ifnull(count(distinct n2.nsryh_id),0) rzyh ,
			ifnull(count(distinct la.la_id),0) sqdk ,
		    ifnull(temp2.sxbs1,0) sxbs,
		    ROUND(ifnull(temp2.sxze1,0) , 2) sxze
		from tb_province_cities pc 
			join tb_regions r  on pc.pc_code=r.region_code
			left join tb_nsryh n on r.region_id=n.region_id
			<if test="starttime !=null and starttime !='' and endtime !=null and endtime !='' ">
					and date_format(n.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') 
						and date_format(#{endtime}, '%Y-%c-%d')
			</if>
			left join tb_nsryh n2 on r.region_id=n2.region_id and n.nsryh_id=n2.nsryh_id and n2.enabled='Y'
			<if test="starttime !=null and starttime !='' and endtime !=null and endtime !='' ">
					and date_format(n2.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') 
						and date_format(#{endtime}, '%Y-%c-%d')
			</if>
			left join tb_loan_apply la on la.region_id=r.region_id 
			<if test="starttime !=null and starttime !='' and endtime !=null and endtime !='' ">
					and (date_format(la.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') 
						and date_format(#{endtime}, '%Y-%c-%d'))
			</if>
			left join (select ifnull(count(A.la_id),0) sxbs1 ,ifnull(sum(A.lar_credit_quota),0) sxze1 ,max(A.region_id) regionid1
						from (select 
							tb_loan_approve_rec.lar_id,
							tb_loan_approve_rec.region_id,
							tb_loan_approve_rec.fp_id,
							tb_loan_approve_rec.la_id,
							tb_loan_approve_rec.las_id,
							tb_loan_approve_rec.lar_credit_quota,
							tb_loan_approve_rec.lar_loan_deadline,
							tb_loan_approve_rec.lar_rate,
							tb_loan_approve_rec.updatetime,
							tb_loan_approve_rec.lar_bank_name
						from 
							tb_loan_approve_rec
							join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id		
							join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
							join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
						where
							tb_loan_approve_rec.las_id =3
							<if test="starttime !=null and starttime !='' and endtime !=null and endtime !='' ">
									and date_format(tb_loan_approve_rec.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') 
										and date_format(#{endtime}, '%Y-%c-%d')
							</if>
							) A 
					group by A.region_id) temp2 on temp2.regionid1=r.region_id
		
		<where>
			<if test="pcId !=null and pcId !='' ">
				pc.pc_id = #{pcId} or pc.pc_pid = #{pcId}
				or pc.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )
			</if>
		</where>
		group by pc.pc_code
	</select> -->
	
	
	<select id="areastatistics_bef" parameterType="map" resultMap="areastatisticsMap" flushCache="true" useCache="true">
		<!-- modify by xiecui 2018/04/02 begin -->
		
		<!-- select tot.* from(
		select tta.tax_id taxid,tta.tax_name areaname,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rzyh,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze,IFNULL(sum(cal.sqdk),0) sqdk
		from tb_tax_authority_code tta,(
		select tac.tax_id taxid,tac.tax_prc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,d.sqdk,tac.swjbz from tb_tax_authority_code tac
		left join
		(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
		from tb_nsryhxx nsrxx 
		<if test="province !=null and province !='' and city==null">
			where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by nsrxx.nsryhxx_swjgdm) a
		on tac.tax_id=a.nsryhxx_swjgdm
		left join
		(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
		<if test="province !=null and province !='' and city==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
		left join
		(
		select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
		and ((ta.nsrsbh=nsrxx.nsryhxx_nsrsbh and ta.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = ta.nsrsbh and ta.nsrsbh!=''))	
		and nsr.enabled='Y' and tar.las_id ='DKZT03'
		<if test="province !=null and province !='' and city==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by nsrxx.nsryhxx_swjgdm) c
		on tac.tax_id= c.nsryhxx_swjgdm
		left join
		(select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
		and ((ta.nsrsbh=nsrxx.nsryhxx_nsrsbh and ta.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = ta.nsrsbh and ta.nsrsbh!='')) and nsr.enabled='Y'
		<if test="province !=null and province !='' and city==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by nsrxx.nsryhxx_swjgdm) d
		on tac.tax_id = d.nsryhxx_swjgdm
		)
		cal
		where (tta.tax_id=cal.tax_prc_id and cal.swjbz='') or (tta.tax_id=cal.taxid and cal.swjbz in('Y','K'))
		or tta.tax_id =
		(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
		(select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =cal.taxid))
		group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot where tot.swjbz in('Y','K')
		<if test="province !=null and province !='' and city==null">
			and substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if> -->
		
		select max(t.taxid) taxid,max(t.areaname) areaname,max(t.swjbz) swjbz,sum(t.zcyh) zcyh,sum(t.rzyh) rzyh,sum(t.sxbs) sxbs,sum(t.sxze) sxze,sum(t.sqdk) sqdk from 
		(select tot.* from(
				select tta.tax_id taxid,tta.tax_name areaname,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rzyh,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze,IFNULL(sum(cal.sqdk),0) sqdk
				from tb_tax_authority_code tta
				,(
				select tac.tax_id taxid,tac.tax_prc_id,(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
				  (select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =tac.tax_id)) tax_pprc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,d.sqdk,tac.swjbz from tb_tax_authority_code tac
				left join
				(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
				from tb_nsryhxx nsrxx 
					<if test="province !=null and province !='' and city==null">
					where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm) a
				on tac.tax_id=a.nsryhxx_swjgdm
				left join
				(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!--and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
				left join
				(select sum(t.sxze) sxze,sum(t.sxbs) sxbs,max(t.nsryhxx_swjgdm) nsryhxx_swjgdm from (
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh	
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm
				
				union all
				
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm) t
				group by t.nsryhxx_swjgdm
				) c
				on tac.tax_id= c.nsryhxx_swjgdm
				left join
				(select sum(t.sqdk) sqdk,max(t.nsryhxx_swjgdm) nsryhxx_swjgdm from (
				select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
				and nsr.enabled='Y'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm
				
				union all
				
				select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh  
				and nsr.enabled='Y'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm ) t
				group by t.nsryhxx_swjgdm
				) d
				on tac.tax_id = d.nsryhxx_swjgdm
				)
				cal where 
				 tta.tax_id=cal.tax_prc_id and cal.swjbz=''
				group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot where tot.swjbz in('Y','K')
					<if test="province !=null and province !='' and city==null">
					and substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
		
		union all 
		
		select tot.* from(
				select tta.tax_id taxid,tta.tax_name areaname,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rzyh,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze,IFNULL(sum(cal.sqdk),0) sqdk
				from tb_tax_authority_code tta
				,(
				select tac.tax_id taxid,tac.tax_prc_id,(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
				  (select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =tac.tax_id)) tax_pprc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,d.sqdk,tac.swjbz from tb_tax_authority_code tac
				left join
				(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
				from tb_nsryhxx nsrxx 
					<if test="province !=null and province !='' and city==null">
					where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm) a
				on tac.tax_id=a.nsryhxx_swjgdm
				left join
				(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!--and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
				left join
				(select sum(t.sxze) sxze,sum(t.sxbs) sxbs,max(t.nsryhxx_swjgdm) nsryhxx_swjgdm from (
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh	
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm
				
				union all
				
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm) t
				group by t.nsryhxx_swjgdm
				) c
				on tac.tax_id= c.nsryhxx_swjgdm
				left join
				(select sum(t.sqdk) sqdk,max(t.nsryhxx_swjgdm) nsryhxx_swjgdm from (
				select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
				and nsr.enabled='Y'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm
				
				union all
				
				select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh  
				and nsr.enabled='Y'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm ) t
				group by t.nsryhxx_swjgdm
				) d
				on tac.tax_id = d.nsryhxx_swjgdm
				)
				cal where 
				 tta.tax_id=cal.taxid and cal.swjbz in('Y','K')
				group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot where tot.swjbz in('Y','K')
					<if test="province !=null and province !='' and city==null">
					and substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
		
		union ALL
		
		select tot.* from(
				select tta.tax_id taxid,tta.tax_name areaname,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rzyh,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze,IFNULL(sum(cal.sqdk),0) sqdk
				from tb_tax_authority_code tta
				,(
				select tac.tax_id taxid,tac.tax_prc_id,(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
				  (select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =tac.tax_id)) tax_pprc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,d.sqdk,tac.swjbz from tb_tax_authority_code tac
				left join
				(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
				from tb_nsryhxx nsrxx 
					<if test="province !=null and province !='' and city==null">
					where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm) a
				on tac.tax_id=a.nsryhxx_swjgdm
				left join
				(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!--and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
				left join
				(select sum(t.sxze) sxze,sum(t.sxbs) sxbs,max(t.nsryhxx_swjgdm) nsryhxx_swjgdm from (
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh	
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm
				
				union all
				
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm) t
				group by t.nsryhxx_swjgdm
				) c
				on tac.tax_id= c.nsryhxx_swjgdm
				left join
				(select sum(t.sqdk) sqdk,max(t.nsryhxx_swjgdm) nsryhxx_swjgdm from (
				select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
				and nsr.enabled='Y'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				group by nsrxx.nsryhxx_swjgdm
				
				union all
				
				select IFNULL(COUNT(distinct ta.la_id),0) sqdk,nsrxx.nsryhxx_swjgdm from tb_loan_apply ta,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id 
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh  
				and nsr.enabled='Y'
					<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					<!-- and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm ) t
				group by t.nsryhxx_swjgdm
				) d
				on tac.tax_id = d.nsryhxx_swjgdm
				)
				cal where 
				  tta.tax_id =cal.tax_pprc_id and cal.swjbz=''
				group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot where tot.swjbz in('Y','K')
					<if test="province !=null and province !='' and city==null">
					and substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>)t
		group by t.taxid
		<!-- modify by xiecui 2018/04/02 end -->
		
		
		
	<!-- select tot.* from(
		select tta.tax_id taxid,tta.tax_name areaname,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rzyh,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze,IFNULL(sum(cal.sqdk),0) sqdk
		from tb_tax_authority_code tta,
		(select tac.tax_id taxid,tac.tax_prc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,d.sqdk,tac.swjbz from tb_tax_authority_code tac
		left join
		(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm,nsrxx.creatorid,nsrxx.nsryhxx_id 
		from tb_nsryhxx nsrxx 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			where date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		group by nsrxx.nsryhxx_swjgdm) a
		on tac.tax_id=a.nsryhxx_swjgdm
		left join
		(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
		left join
		(select round(IFNULL(sum(lar.lar_credit_quota),0),2) sxze,count(1) as sxbs,la.creatorid,la.la_id from tb_loan_approve_rec lar,tb_loan_apply la where 
		lar.la_id=la.la_id and las_id=3 and la.la_status in (3,7) 

		group by la.creatorid) c
		on a.creatorid= c.creatorid
		left join 
		(select IFNULL(COUNT(DISTINCT la.la_id),0) sqdk,la.creatorid from tb_loan_apply la group by la.creatorid) d
		on a.creatorid = d.creatorid
		) cal
		where (tta.tax_id=cal.tax_prc_id and cal.swjbz='') or (tta.tax_id=cal.taxid and cal.swjbz in('Y','K'))
		group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot where tot.swjbz in('Y','K')
	
		<if test="province !=null and province !='' ">
			and substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' "> 
			and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		</if>
		<if test="city !=null and city !='' ">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="isChongQing != null and isChongQing == 'yes'">
			and tot.swjbz='Y'
		</if>  -->
	</select>
	<!-- <select id="areastatistics" parameterType="map" resultMap="areastatisticsMap" flushCache="true" useCache="true">
	<if test="currentarea=='province'.toString()">
		select cc.tax_id taxid,cc.tax_name areaname,sum(dd.zcyh) zcyh,sum(dd.rzyh) rzyh,sum(dd.sxbs) sxbs,sum(dd.sxze) sxze,sum(dd.sqdk) sqdk from tb_tax_authority_code cc,(
	</if>
	SELECT 
			tac.tax_id taxid,
			tac.tax_prc_id,
			tac.tax_name areaname,
			IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,
			IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rzyh,
			IFNULL(count(distinct lar.la_id),0) sxbs,
			round(IFNULL(sum(lar.lar_credit_quota),0),2) sxze,
			IFNULL(COUNT(DISTINCT la.la_id),0) sqdk
		FROM tb_tax_authority_code tac

		LEFT JOIN tb_nsryhxx nsrxx ON nsrxx.nsryhxx_swjgdm=tac.tax_id
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		LEFT JOIN tb_loan_apply la2 ON la2.creatorid=nsrxx.creatorid
		<if test="currentarea=='province'.toString()">
			LEFT JOIN tb_province_cities pc ON substring(tac.tax_id,2,2) = substring(pc.pc_code,1,2)
		</if>
		<if test="currentarea=='city'.toString()">
			LEFT JOIN tb_province_cities pc ON substring(tac.tax_id,2,4) = substring(pc.pc_code,1,4)
		</if>
		<if test="currentarea=='area'.toString()">
			LEFT JOIN tb_province_cities pc ON substring(tac.tax_id,2,6) = substring(pc.pc_code,1,6)
		</if>
		

		left join tb_nsryh nsr on nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsr.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		left join tb_loan_apply la on la.creatorid=nsrxx.creatorid 
		left join tb_loan_approve_rec lar on lar.la_id=la.la_id and lar.las_id=3
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(lar.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		<choose>
            <when test="currentarea=='area'.toString()">
                   where pc.pc_id= #{pcId} 
                   <if test="isChongQing != null and isChongQing == 'no'">
                  	 and tac.swjbz='Y'
                   </if>
            </when>
            <otherwise>
                   <where>
	                   <if test="pcId != null and pcId != ''">
							pc.pc_pid= #{pcId} 
							<if test="isChongQing != null and isChongQing == 'no'">
								and tac.swjbz='Y'
							</if>
				       </if>
				       
                   </where>
            </otherwise>
        </choose>
		GROUP BY tac.tax_id
		ORDER BY tac.tax_id ASC
		<if test="currentarea=='province'.toString()">
			) dd where  cc.tax_id = dd.tax_prc_id group by cc.tax_id,cc.tax_name
		</if>
	</select> -->
	
	<!-- ***********************统计功能优化****************************** -->
	<select id="areastatistics" parameterType="map" resultMap="areastatisticsMap" flushCache="true" useCache="true">
		SELECT  a.taxname areaname, a.zcyh zcyh, a.rzyh rzyh, b.sqdk sqdk, b.sxbs sxbs, b.sxze sxze FROM 
		(
		SELECT MAX(dqyh.`taxid`) taxid,MAX(dqyh.`taxname`) taxname,IFNULL(SUM(dqyh.`zcyh`),0) zcyh,IFNULL(SUM(dqyh.`rzyh`),0) rzyh FROM `tb_statistics_dqyh` dqyh 
		<where>
			swjbz IN ('Y','K')
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(dqyh.`taxid`,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
				<if test="isChongQing != null and isChongQing == 'yes'">
	             and SUBSTRING(dqyh.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
	            <if test="isChongQing != null and isChongQing == 'no'">
	              and SUBSTRING(dqyh.`taxid`,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and SUBSTRING(dqyh.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(dqyh.`zcrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
		</where>
		GROUP BY dqyh.`taxid`
		)a,
		(
		SELECT MAX(dqdk.`taxid`) taxid,MAX(dqdk.`taxname`) taxname,IFNULL(SUM(dqdk.`sdbs`),0) sqdk,IFNULL(SUM(dqdk.`sxbs`),0) sxbs,IFNULL(SUM(dqdk.`sxze`),0) sxze FROM `tb_statistics_dqdk` dqdk 
		<where>
			swjbz IN ('Y','K')
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(dqdk.`taxid`,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
				<if test="isChongQing != null and isChongQing == 'yes'">
	             and SUBSTRING(dqdk.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
	            <if test="isChongQing != null and isChongQing == 'no'">
	              and SUBSTRING(dqdk.`taxid`,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and SUBSTRING(dqdk.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(dqdk.`sdrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
		</where>
		GROUP BY dqdk.`taxid`
		)b
		WHERE a.taxid=b.taxid
	
	</select>
	
	<select id="areastatistics1" parameterType="map" resultMap="areastatisticsMap" flushCache="true" useCache="true">
		 select pc.pc_name areaName,
		 		rst.*
		 		 from (
		  SELECT COUNT(distinct fc.ENTCREDITID) rzyh,
				 COUNT(distinct fc.BUSINESSID) sqdk,
				 (COUNT(fc.admittance)-sum(fc.admittance)) sxbs,
				 sum(fc.LOANAMOUNT) sxze,
				 <if test="level==1">
				 pc_city  pc_code
				 </if>
				 <if test="level==2">
				 pc_area pc_code
				 </if>
				 <if test="level==3">
				 pc_area pc_code
				 </if>
				 from fact_dkxx fc
				 left join tb_province_cities t 
				 on t.pc_code=fc.xzqhszdm 
		  <where>
 				 <if test="starttime!='' and starttime!=null">
 				 and fc.APPLYTIME &gt;= '${starttime}'
 				 </if>
 				 <if test="endtime!='' and endtime!=null">
 				 and fc.APPLYTIME &lt;= '${endtime}' and
 				 </if>
 				 <if test="level==1 and xzqh!=null and xzqh!=''">
 				 t.pc_province=${xzqh}
 				 group by t.pc_city
 				 </if>
 				 <if test="level==2 and xzqh!=null and xzqh!=''">
 				 t.pc_city=${xzqh} 
 				 group by t.pc_area
 				 </if>
 				 <if test="level==3 and xzqh!=null and xzqh!=''">
 				 t.pc_area=${xzqh} 
 				 group by t.pc_area
 				 </if>
 				 ) rst left join tb_province_cities pc on rst.pc_code = pc.pc_code
 		  </where>
		 		 
		 		 
 		  
	</select>
</mapper>