<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.bankmanager.mapper.BankManagerMapper" >
<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
  <resultMap id="bankManagerMap" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.BMListModel" >
    <id column="fp_id" property="fpId" />
    <result column="fp_name" property="fpName"  />
    <result column="starttime" property="starttime"  />
    <result column="endtime" property="endtime"  />
    <result column="bank_id" property="bankId"  />
    <result column="bankcode" property="bankCode"  />
    <result column="bankname" property="bankName"  />
    <result column="bankdepartment" property="bankdepartment"  />
    <result column="status" property="status" />
    <result column="apply_require" property="applyRequire"/>
    <result column="contactname" property="contactName" />
    <result column="contactphone" property="contactphone" />
    <result column="contacttelephone" property="contacttelephone" />
    <result column="leadername" property="leadername" />
    <result column="leadertelephone" property="leadertelephone" />
    <result column="leaderphone" property="leaderphone" />
    <result column="countnumber" property="dataCounter" />
    <result column="frequencylimit" property="frequencylimit" />
    <result column="createtime" property="createTime" />
    <result column="updatetime" property="updateTime" />
  </resultMap>
  <resultMap id="taxOptionRecord" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.TaxOptionRecord" >
    <id column="xh" property="pkey" />
    <result column="yhdm" property="bandCode"  />
    <result column="yhmc" property="bankName" />
    <result column="bankcode" property="bankcode" />
    <result column="gsdataid" property="taxOptionId" />
    <result column="cjsj" property="createTime" />
  </resultMap>
  <resultMap id="businessRegInfo" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.BusinessRegInfo" >
    <result column="allcount" property="allCount"  />
    <result column="percount" property="perCount" />
    <result column="gsbmc" property="gsbmc" />
    <result column="cftOptions" property="cftOptions" />
  </resultMap>
  <resultMap id="taxOptionInfo" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.TaxOptionInfo" >
    <result column="xh" property="pkey"  />
    <result column="gsbmc" property="dataHeader"  />
    <result column="bzdmc" property="fieldName" />
    <result column="gsbdm" property="tableName" />
    <result column="sign" property="sign"/>
    <result column="fieldCounter" property="fieldCounter" />
  </resultMap>
 
  <resultMap id="taxRegInfo" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.TaxRegInfo" >
  	<result column="zgswskfj_dm" property="zgswskfj_dm"  />
    <result column="nsrzg_dm" property="nsrzg_dm"  />
    <result column="sfxxwlqy" property="sfxxwlqy" />
    <result column="zzsl" property="zzsl" />
    <result column="zzsnspl" property="zzsnspl" />
    <result column="sdsl" property="sdsl" />
    <result column="sdsnspl" property="sdsnspl" />
	<result column="swxypj" property="swxypj" />
	<result column="swxypjsj" property="swxypjsj" />
	<result column="swxypffs" property="swxypffs" />
	<result column="fddbrhfzrhyzxm" property="fddbrhfzrhyzxm" />
	<result column="fddbrhfzrhyzsfzjzl_dm" property="fddbrhfzrhyzsfzjzl_dm" />
	<result column="fddbrhfzrhyzsfzjhm" property="fddbrhfzrhyzsfzjhm" />
	<result column="fddbrhfzrhyzgddh" property="fddbrhfzrhyzgddh" />
	<result column="fddbrhfzrhyzyddh" property="fddbrhfzrhyzyddh" />
	<result column="bsrxm" property="bsrxm" />
	<result column="bsrsfzjzl_dm" property="bsrsfzjzl_dm" />
	<result column="bsrsfzjhm" property="bsrsfzjhm" />
	<result column="bsrgddh" property="bsrgddh" />
	<result column="bsryddh" property="bsryddh" />
	<result column="cwfzrxm" property="cwfzrxm" />
	<result column="cwfzrsfzjzl_dm" property="cwfzrsfzjzl_dm" />
	<result column="cwfzrsfzjhm" property="cwfzrsfzjhm" />
	<result column="cwfzrgddh" property="cwfzrgddh" />
	<result column="cwfzryddh" property="cwfzryddh" />
	<result column="swdlrmc" property="swdlrmc" />
	<result column="swdlrnsrsbh" property="swdlrnsrsbh" />
  </resultMap>
  
  <resultMap id="bankOrgMap" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.BankOrg" >
  		<result column="org_id" property="bankId"/>
    	<result column="org_code" property="bankCode" />
    	<result column="org_name" property="bankName" />
  </resultMap>
  <!-- 银行产品resultMap -->
  <resultMap id="fpOrgMap" type="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.FPOrg" >
	    <id column="fp_id"  property="fpId" />
	    <result column="fp_name" property="fpName" />
  </resultMap>
  
	<!--根据bankId查询该银行下未配置数据项的金融产品 -->
	<select id="findFPsByBankId" parameterType="String" resultMap="fpOrgMap" flushCache="true" useCache="true">
		SELECT fp.fp_id,fp.fp_name FROM tb_financial_product fp WHERE fp.org_id = #{bankId} AND fp.enabled='Y'
			AND fp.fp_id NOT IN (SELECT DISTINCT jl.fp_id FROM dm_gsdata_jl jl WHERE jl.yhdm=fp.org_id )
	</select>
	<!--根据bankId查询该银行下的金融产品 -->
	<select id="findFPList" parameterType="String" resultMap="fpOrgMap" flushCache="true" useCache="true">
		SELECT fp.fp_id,fp.fp_name FROM tb_financial_product fp WHERE fp.org_id = #{bankId} AND fp.enabled='Y'
	</select>
	<!--根据bankCode查询该银行下的金融产品 -->
	<select id="findFpList" parameterType="String" resultMap="fpOrgMap" flushCache="true" useCache="true">
		SELECT fp.fp_id,fp.fp_name FROM gs_syptbankdataconfig fp WHERE fp.bankcode = #{bankId}
	</select>
  <!-- 搜索数据  3.0v增加部分字段   modify by Sigua.Huang 2018/06/20-->
	<select id="queryBMList" parameterType="String" resultMap="bankManagerMap" flushCache="true" useCache="true">
		select bk.status,bk.fp_id,bk.fp_name,bk.bankcode,bk.bankname,bk.bankdepartment,bk.contactname,bk.contactphone,bk.contacttelephone,
		bk.leadername,bk.leadertelephone,bk.leaderphone,bk.createtime,bk.updatetime,count(taxrec.gsdataid) as countnumber
		from gs_syptbankdataconfig bk,dm_gsdata_jl taxrec,tb_organizations org,dm_gsdata_dm dm
		where bk.fp_id=taxrec.fp_id and bk.bankcode=taxrec.yhdm and bk.bankcode = org.org_code
		AND dm.xh = taxrec.gsdataid AND dm.sign = '1'
		<if test="regionId != null and regionId != ''">
			and org.region_id=#{regionId}
		</if>
		<if test="searchKey!= null and searchKey!= ''">
			and (bk.fp_id LIKE CONCAT('%',#{searchKey},'%') or bk.fp_name LIKE CONCAT('%',#{searchKey},'%' ))
		</if> 
		group by bk.fp_id
	</select>
	<select id="queryBmModel" parameterType="String" resultMap="bankManagerMap" flushCache="true" useCache="true">
		select a.fp_id,a.fp_name,a.bank_id,a.apply_require,a.starttime,a.endtime,a.bankcode,a.bankname,a.status,a.bankdepartment,a.contactname,
		a.contactphone,a.contacttelephone,a.leadername,a.leadertelephone,a.leaderphone,a.frequencylimit,a.createtime,a.updatetime,a.opentime
		from gs_syptbankdataconfig a
		where a.fp_id=#{fpId} AND a.bankcode = #{bankCode}
	</select>
	<!-- 查询该region_id下的所有银行，当银行下的产品数量与该银行已配置的产品数量相等，则默认银行下所有产品已被配置，不展示 -->
  	<select id="queryBankOrg" resultMap="bankOrgMap" flushCache="true" useCache="true">
		select org.org_id,org.org_code,org.org_name from tb_organizations org where org.enabled ='Y'
		<if test="regionId != null and regionId != ''">
			and org.region_id=#{regionId}
		</if>
		and  org.ot_id = 'ZZLX002' and org.org_id in(
												SELECT tborg.org_id FROM
													(select tfp.org_id,count(tfp.fp_id) fpnum FROM tb_financial_product tfp
													GROUP BY tfp.org_id)tborg
												WHERE NOT EXISTS (
													SELECT tb.bank_id,tb.fpcount FROM
													(SELECT bf.bank_id,count(bf.fp_id) fpcount FROM gs_syptbankdataconfig bf GROUP BY bf.bank_id
													)tb WHERE tb.bank_id = tborg.org_id AND tb.fpcount = tborg.fpnum
												)) 
	</select>
	<!-- 查询该region_id下的所有银行 -->
  	<select id="queryBankList" resultMap="bankOrgMap" flushCache="true" useCache="true">
		select org.org_id,org.org_code,org.org_name from tb_organizations org where org.enabled ='Y'
		<if test="regionId != null and regionId != ''">
			and org.region_id=#{regionId}
		</if>
		and  org.ot_id = 'ZZLX002'
	</select>
	<!-- 银行税务配置 -->
	<select id="queryBusinessRegInfo" parameterType="String" resultMap="businessRegInfo" flushCache="true" useCache="true">
		<!-- select nsrmc,shxydm,gszch,nsrsbh,zzjg_dm,scjydlxdh,scjydz,sf,sq,hy_dm,hymx from gs_syptgsdjxx_pz 
		where bankcode = #{bankCode} -->
		select a.allcount,b.gsbmc,b.cftOptions,b.percount from
		(select count(0) allcount,dm.gsbdm from dm_gsdata_dm dm group by dm.gsbdm) a,
		(select dm.gsbdm,dm.gsbmc,count(0) percount,group_concat(dm.bzdmc separator ';') cftOptions
			from dm_gsdata_dm dm,dm_gsdata_jl taxrec
			where dm.xh = taxrec.gsdataid and taxrec.fp_id =#{fpId}
			group by dm.gsbdm) b
			where a.gsbdm = b.gsbdm
	</select>
	<select id="queryTaxRegInfo" parameterType="String" resultMap="taxRegInfo" flushCache="true" useCache="true">
		select zgswskfj_dm,nsrzg_dm,sfxxwlqy,zzsl,zzsnspl,sdsl,sdsnspl,swxypj,swxypjsj,swxypffs,fddbrhfzrhyzxm,
		fddbrhfzrhyzsfzjzl_dm,fddbrhfzrhyzsfzjhm,fddbrhfzrhyzgddh,fddbrhfzrhyzyddh,bsrxm,bsrsfzjzl_dm,
		bsrsfzjhm,bsrgddh,bsryddh,cwfzrxm,cwfzrsfzjzl_dm,cwfzrsfzjhm,cwfzrgddh,cwfzryddh,swdlrmc,swdlrnsrsbh
		from gs_syptswdjxx_pz 
		where bankcode = #{bankCode}
	</select>
	<select id="queryTaxOption"  parameterType="java.util.Map" resultMap="taxOptionInfo" flushCache="true" useCache="true">
		<!-- select xh,gsbmc,bzdmc from dm_gsdata_dm where gsbdm =#{tableName} -->
		select dm.xh,dm.gsbmc,dm.bzdmc,dm.gsbdm,dm.sign,
		case when rec.gsdataid is null then 'N'
		else 'Y' end as selected
		from dm_gsdata_dm dm
		left join dm_gsdata_jl rec on dm.xh = rec.gsdataid
		<if test="fpId != null and fpId != '' and bankCode != null and bankCode != ''">
			and rec.fp_id=#{fpId} and rec.yhdm=#{bankCode}
		</if>
		<if test="tableName != null and tableName != ''">
			where dm.gsbdm=#{tableName}
		</if>
		order by dm.xh
	</select>
	<!-- 查询该银行产品税局配置的数据项  -->
	<select id="findDataByFpId"  parameterType="String" resultMap="taxOptionInfo" flushCache="true" useCache="true">
		select dm.gsdataid xh from dm_gsdata_jl dm where fp_id=#{fpId} and yhdm=#{bankCode} order by dm.xh
	</select>
	<!-- 对修改前数据项的记录  -->
  	<insert id="recordDataUpdate" parameterType="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.DataUpdateRecord" >
		INSERT INTO tb_gz_dataupdate_record 
				(bankid,fp_id,data_items,createid,createtime,starttime,endtime,opentime)
		VALUES	(#{bankid},#{fpId},#{dataItems},#{createId},NOW(),#{starttime},#{endtime},#{opentime})
	</insert>
	<!-- 关联查询数据项，此处的总条数不包括sign='2'其他标识的个数 -->
	<select id="queryTaxOptionTe"  parameterType="java.util.Map" resultMap="taxOptionInfo" flushCache="true" useCache="true">
		select dm.xh,dm.gsbdm,dm.gsbmc,dm.bzdmc,a.fieldCounter,dm.sign,
		case when rec.gsdataid is null then 'N'
		else 'Y' end as selected
		from dm_gsdata_dm dm 
		left join
		(select count(*) fieldCounter,d.gsbdm from dm_gsdata_dm d where (d.sign='0' or d.sign='1') group by d.gsbdm)a on dm.gsbdm = a.gsbdm
		left join
		dm_gsdata_jl rec on dm.xh = rec.gsdataid 
		and rec.fp_id=#{fpId} and rec.yhdm=#{bankCode}
		where dm.yxbz='Y' group by dm.xh order by dm.xh
	</select>
  <!-- 插入数据  3.0v增加部分字段   modify by Sigua.Huang 2018/06/20-->
  <insert id="insertBMListModel" parameterType="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.BMListModel" >
    insert into gs_syptbankdataconfig(fp_id,fp_name,bank_id,bankcode,bankname,status,bankregionid,bankdepartment,contactname,contactphone,
    contacttelephone,leadername,leadertelephone,leaderphone, frequencylimit,apply_require,starttime,endtime,createtime,updatetime)
    values(#{fpId},#{fpName},#{bankId},#{bankCode},#{bankName},#{status},#{bankregionid},#{bankdepartment},#{contactName},#{contactphone},
    #{contacttelephone},#{leadername},#{leadertelephone},#{leaderphone},#{frequencylimit},#{applyRequire},#{starttime},#{endtime},now(),now())
  </insert>
  <insert id="insertBusinessRegInfo" parameterType="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.BusinessRegInfo" >
    insert into gs_syptgsdjxx_pz(bankcode,nsrmc,shxydm,gszch, nsrsbh,zzjg_dm,scjydlxdh,scjydz,
    sf, sq,hy_dm,hymx,hy_mc,countnumber)
    values(#{bankcode},#{nsrmc},#{shxydm},#{gszch},#{nsrsbh},#{zzjg_dm},#{scjydlxdh},
    #{scjydz},#{sf},#{sq},#{hy_dm},#{hymx},#{hy_mc},#{countnumber})
  </insert>
  <insert id="insertTaxRegInfo" parameterType="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.TaxRegInfo" >
    insert into gs_syptswdjxx_pz(bankcode,zgswskfj_dm,nsrzg_dm,sfxxwlqy, zzsl,zzsnspl,sdsl,sdsnspl,swxypj,swxypjsj,
    swxypffs,fddbrhfzrhyzxm,fddbrhfzrhyzsfzjzl_dm,fddbrhfzrhyzsfzjhm,fddbrhfzrhyzgddh,fddbrhfzrhyzyddh,bsrxm,bsrsfzjzl_dm,
    bsrsfzjhm,bsrgddh,bsryddh,cwfzrxm,cwfzrsfzjzl_dm,cwfzrsfzjhm,cwfzrgddh,cwfzryddh,swdlrmc,swdlrnsrsbh,countnumber)
    values(#{bankcode},#{zgswskfj_dm},#{nsrzg_dm},#{sfxxwlqy},#{zzsl},#{zzsnspl},#{sdsl},#{sdsnspl},#{swxypj},
    #{swxypjsj},#{swxypffs},#{fddbrhfzrhyzxm},#{fddbrhfzrhyzsfzjzl_dm},#{fddbrhfzrhyzsfzjhm},#{fddbrhfzrhyzgddh},
    #{fddbrhfzrhyzyddh},#{bsrxm},#{bsrsfzjzl_dm},#{bsrsfzjhm},#{bsrgddh},#{bsryddh},#{cwfzrxm},#{cwfzrsfzjzl_dm},
    #{cwfzrsfzjhm},#{cwfzrgddh},#{cwfzrgddh},#{swdlrmc},#{swdlrnsrsbh},#{countnumber})
  </insert>
  
  <insert id="insertTaxOpt" parameterType="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.TaxOptionRecord">
    insert into dm_gsdata_jl(xh, yhdm, fp_id, fp_name, gsdataid, cjsj)
    values 
    (#{pkey},#{bankcode},#{fpId},#{fpName},#{taxOptionId},now())
  </insert>
  <insert id="insertTaxOptList" parameterType="java.util.List">
    insert into dm_gsdata_jl(xh, yhdm, fp_id, fp_name, gsdataid, cjsj)
    values 
    <foreach collection="list" item="perOpt" index="index" separator="," >
    	(#{perOpt.pkey},#{perOpt.bankcode},#{perOpt.fpId},#{perOpt.fpName},#{perOpt.taxOptionId},now())
     </foreach>
  </insert>

<!-- 对状态的修改，如果将状态改为开通，则需记录开通时间 -->
<update id="updateBankStatus" parameterType="java.util.Map" >
    update gs_syptbankdataconfig set status = #{status},updatetime=now() 
    <if test='status == "1"'>
    	,opentime=now()
    </if>
    where 
    	<foreach collection="fpIdBankCodeList" item="bmListModel" index="index" open="(" close=")" separator=" or ">
         	fp_id = #{bmListModel.fpId} AND bankcode = #{bmListModel.bankCode} 
    	</foreach> 
</update>

<update id="updateBMModel" parameterType="com.dcits.govsbu.sd.taxbankplatform.bankmanager.model.BMListModel" >
    update gs_syptbankdataconfig 
    <set>
      <if test="contactName != null and contactName !=''">
        contactname = #{contactName},
      </if>
      <if test="contactphone != null and contactphone !=''">
        contactphone = #{contactphone},
      </if>
      <if test="contacttelephone != null and contacttelephone !=''">
        contacttelephone = #{contacttelephone},
      </if>
      <if test="bankdepartment != null and bankdepartment !=''">
        bankdepartment = #{bankdepartment},
      </if>
      <if test="leadername != null and leadername !=''">
        leadername = #{leadername},
      </if>
      <if test="leadertelephone != null and leadertelephone !=''">
        leadertelephone = #{leadertelephone},
      </if>
      <if test="leaderphone != null and leaderphone !=''">
        leaderphone = #{leaderphone},
      </if>
      <if test="frequencylimit != null and frequencylimit !=''">
        frequencylimit = #{frequencylimit},
      </if>
      <if test="applyRequire != null and applyRequire !=''">
        apply_require = #{applyRequire},
      </if>
      <if test="starttime != null and starttime !=''">
        starttime = #{starttime},
      </if>
      <if test="endtime != null and endtime !=''">
        endtime = #{endtime},
      </if>
      updatetime=now() 
    </set>
	 where fp_id = #{fpId}
</update>


<delete id="deleteTaxOptionByBKCode" parameterType="String">
<![CDATA[  
      delete from dm_gsdata_jl where fp_id = #{fpId} AND yhdm =  #{bankCode}
    ]]>  
</delete>
	
</mapper>