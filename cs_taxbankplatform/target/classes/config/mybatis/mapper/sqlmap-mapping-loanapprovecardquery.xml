<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.loanapprove.mapper.LoanApproveCardMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 

	<!-- 信用卡申请(初审/终审)列表 -->
	<resultMap id="loanCardList" type="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.LoanCardQueryEntity">
		<id property="la_id" column="la_id"/>
		<result property="la_apply_time" column="la_apply_time" />
		<result property="nsryhxx_qymc" column="nsryhxx_qymc"/>
		<result property="fp_name" column="fp_name"/>
		<result property="la_status" column="la_status"/>
	</resultMap>
	
	<resultMap id="totalDataMap" type="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.TotalDataEntity" >
    <result column="dsl" property="dsl" />
    <result column="wsl" property="wsl" />
    <result column="dsx" property="dsx" />
    <result column="sxzz" property="sxzz" />
    <result column="zdzz" property="zdzz" />
    <result column="ysx" property="ysx" />
    <result column="whdsx" property="whdsx" />
    <result column="total" property="total" />
    <result column="slbtg" property="slbtg" />
     
    <result column="sxwc" property="sxwc" />
    <result column="dpzcx" property="dpzcx" />
    <result column="ypzcx" property="ypzcx" />
    <result column="ytd" property="ytd" />
  </resultMap>
  
	<!-- 获取看板管理类的统计数据 -->
	<select id="queryTotalData" parameterType="map" resultMap="totalDataMap" flushCache="true" useCache="true">
		SELECT 
			 IFNULL(SUM(CONCAT(la.la_status=1)),0) AS dsl, 
			 IFNULL(SUM(CONCAT(la.la_status=5)),0) AS wsl, 
			 IFNULL(SUM(CONCAT(la.la_status=2)),0) AS dsx,
			 IFNULL(SUM(CONCAT(la.la_status=3)),0) AS ysx, 
			 IFNULL(SUM(CONCAT(la.la_status=4)),0) AS whdsx, 
			 IFNULL(SUM(CONCAT(la.la_status=6)),0) AS slbtg, 
			 IFNULL(SUM(CONCAT(la.la_status=7)),0) AS sxwc, 
			 IFNULL(SUM(CONCAT(la.la_status=8)),0) AS dpzcx, 
			 IFNULL(SUM(CONCAT(la.la_status=9)),0) AS ypzcx, 
			 IFNULL(SUM(CONCAT(la.la_status=10)),0) AS ytd,
			 IFNULL(COUNT(*),0) AS total
		FROM tb_loan_apply la,tb_nsryhxx nsr,tb_financial_product fp,tb_nsryh yh
		WHERE 
			la.creatorid = yh.nsryh_id
			and yh.nsryhxx_id=nsr.nsryhxx_id
			and yh.enabled = 'Y'
			and fp.fp_id=la.fp_id 
			and fp.org_id=#{orgid} and fp.pt_dm=#{pt_dm}
	</select>
	
	
	<!-- 查询信用卡(初审/终审)申请列表-->
	<select id="queryListByPage" parameterType="map" resultMap="loanCardList" flushCache="true" useCache="true">
			SELECT 
				la.la_id,fp.fp_name,nsr1.nsryhxx_qymc,la.la_apply_time,la.la_status
			FROM tb_loan_apply la,tb_financial_product fp,tb_nsryhxx nsr1,tb_nsryh yh
			<where>
				la.fp_id = fp.fp_id
				and la.creatorid = nsr1.creatorid
				and yh.nsryhxx_id=nsr1.nsryhxx_id
				and yh.enabled = 'Y'
				and	fp.org_id = #{orgId}
				and fp.pt_dm=#{pt_dm}
				<if test="apply_star != null and apply_star != '' and apply_end != null and apply_end != ''">
					and date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{apply_star}, '%Y-%c-%d') and date_format(#{apply_end}, '%Y-%c-%d')
				</if>
				<if test="nsrmc != null and nsrmc != ''">
					and nsr1.nsryhxx_qymc like concat('%', concat(#{nsrmc}, '%'))
				</if>
				<if test="status != null and status != ''">
					and la.la_status = #{status}
				</if>
			</where>
			ORDER BY la.la_status ASC,la.la_apply_time DESC
		
	</select>
	
	<resultMap id="exportExcelList" type="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.LoanExportExcel">
		<result property="laId" column="la_id"/>
		<result property="larCreditQuota" column="lar_credit_quota"/>
		<result property="larOpinion" column="lar_opinion"/>
		<result property="laApplyTime" column="la_apply_time"/>
		<result property="laStatus" column="la_status"/>
		<result property="lasBankStatus" column="las_bank_status"/>
		<result property="fpName" column="fp_name"/>
		<result property="nsryhxxQymc" column="nsryhxx_qymc"/>
		<result property="nsrsbh" column="nsrsbh"/>
		<result property="laAmount" column="la_amount"/>
		<result property="laRepayLoanDeadline" column="la_repay_loan_deadline"/>
		<result property="rwId" column="rw_id"/>
		<result property="nsrmc" column="nsryhxx_nsrmc"/>
		<result property="zzjgDm" column="nsryhxx_zzjgdm"/>
		<result property="zcdz" column="nsryhxx_zcdz"/>
		<result property="zcdlxdh" column="nsryhxx_zcdzlxdh"/>
		<result property="fddbrmc" column="nsryhxx_frmc"/>
		<result property="sqxh" column="nsryhxx_sqxh"/>
		<result property="frsjh" column="nsryhxx_frsjh"/>
	</resultMap>

	
	<!-- 信用卡申请(初审/终审)明细查询 -->
	<resultMap id="loanCardDetail" type="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.LoanCardDetailEntity">
		<id property="la_id" column="la_id"/>
		
		<!-- 纳税人信息表 -->
		<association property="nsryhxxEntity" javaType="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.NsryhxxEntity">
			<id property="id" column="nsryhxx_id" />
			<result property="qymc" column="nsryhxx_qymc"/>
			<result property="nsrsbh" column="nsryhxx_nsrsbh"/>
			<result property="djrq" column="nsryhxx_djrq"/>
			<result property="zczb" column="nsryhxx_zczb"/>
			<result property="frmc" column="nsryhxx_frmc"/>
			<result property="frsjh" column="nsryhxx_frsjh"/>
			<!-- <result property="hymc" column="nsryhxx_hydm"/> -->
			<result property="hymc" column="hy_mc"/>
			<result property="zcdz" column="nsryhxx_zcdz"/>
			<result property="jyfw" column="nsryhxx_jyfw"/>
		</association>
		
		<!-- 信用卡申请记录表tb_xyk_record -->
		<association property="loanCardRecordEntity" javaType="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.LoanCardRecordEntity">
			<id  property="xr_id" column="xr_id"/>
			<result property="xr_cpmc" column="xr_cpmc"/>
			<result property="xr_yhmc" column="xr_yhmc"/>
			<result property="xr_nsrsbh" column="xr_nsrsbh"/>
			<result property="xr_xydm" column="xr_xydm"/>
			<result property="xr_lxrsj" column="xr_lxrsj"/>
			<result property="xr_lxrdz" column="xr_lxrdz"/>
			<result property="xr_xxdz" column="xr_xxdz"/>
			<result property="xr_lsh" column="xr_lsh"/>
			<result property="xr_ysxzt_dm" column="xr_ysxzt_dm"/>
			<result property="xr_sqjg" column="xr_sqjg"/>
			<result property="xr_ysxsj" column="xr_ysxsj"/>
			<result property="xr_ysxedmin" column="xr_ysxedmin"/>
			<result property="xr_ysxedmax" column="xr_ysxedmax"/>
			<result property="xr_ysxsm" column="xr_ysxsm"/>
			<result property="xr_yxjl_tjdm" column="xr_yxjl_tjdm"/>
			<result property="xr_yhdm" column="xr_yhdm"/>
			<result property="xr_kpzt" column="xr_kpzt"/>
			<result property="xr_zs_sxsj" column="xr_zs_sxsj"/>
			<result property="xr_sxed" column="xr_sxed"/>
			<result property="creatorid" column="creatorid"/>
			<result property="createtime" column="createtime"/>
		</association>
		
		<!-- 审批记录流水表 -->
		<collection property="recList" ofType="com.dcits.govsbu.sd.taxbankplatform.loanapprove.model.LoanApproveRecEntity">
			<id property="id" column="lar_id"/>
			<result property="bh" column="bh"/>
			<result property="las_id" column="las_id"/>
			<result property="lac_id" column="lac_id"/>
			<result property="lar_credit_quota" column="lar_credit_quota"/>
			<result property="lar_loan_deadline" column="lar_loan_deadline"/>
			<result property="lar_begin" column="lar_begin"/>
			<result property="lar_end" column="lar_end"/>
			<result property="lar_rate" column="lar_rate"/>
			<result property="lar_isoverlay_area" column="lar_isoverlay_area"/>
			<result property="rw_id" column="rw_id"/>
			<result property="lar_bank_name" column="lar_bank_name"/>
			<result property="lar_bank_account" column="lar_bank_account"/>
			<result property="lar_contract" column="lar_contract"/>
			<result property="lar_opinion" column="lar_opinion"/>
			<result property="creatorid" column="creatorid"/>
			<result property="createtime" column="createtime"/>
			<result property="updatetime" column="updatetime"/>
		</collection>
	</resultMap>

	
	
	<!-- 根据贷款申请id查询贷款审批记录-->
	<select id="loanCardDetail" parameterType="map" resultMap="loanCardDetail" flushCache="true" useCache="true">
		SELECT 
			la.la_id,
			
			<!-- 信用卡申请记录 -->
			xr.xr_cpmc,
			xr.xr_lxrsj,
			xr.xr_lxrdz,
			xr.xr_xxdz,
			xr.xr_yxjl_tjdm,
			xr.xr_ysxedmin,
			xr.xr_ysxedmax,
			xr.xr_ysxsj,
			xr.xr_ysxsm,
			xr.xr_ysxzt_dm,
			xr.xr_kpzt,
			xr.xr_zs_sxsj,
			xr.xr_sxed,
			
			<!-- 纳税人信息 -->
			nsr.nsryhxx_qymc,
			nsr.nsryhxx_nsrsbh,
			nsr.nsryhxx_djrq,
			nsr.nsryhxx_zczb,
			nsr.nsryhxx_frmc,
			nsr.nsryhxx_frsjh,
			nsr.nsryhxx_hydm,
			ty.hy_mc,
			nsr.nsryhxx_zcdz,
			nsr.nsryhxx_jyfw,
			
			<!-- 审批记录流水 -->
			rec.lar_id,
			rec.las_id,
			rec.createtime,
			rec.lar_opinion,
			rec.lar_credit_quota
		FROM 
			tb_loan_apply la
			LEFT JOIN tb_loan_approve_rec rec ON rec.la_id=la.la_id
			LEFT JOIN tb_xyk_record xr ON xr.xr_lsh=la.la_serial_number
			LEFT JOIN tb_nsryhxx nsr ON nsr.nsryhxx_nsrsbh=la.nsrsbh
			LEFT JOIN tb_nsryh yh ON yh.nsryhxx_id=nsr.nsryhxx_id
			LEFT JOIN tb_hydm ty ON ty.hy_dm=nsr.nsryhxx_hydm
		WHERE 
			yh.enabled='Y' AND la.la_id=#{la_id}
	</select>
	
</mapper>