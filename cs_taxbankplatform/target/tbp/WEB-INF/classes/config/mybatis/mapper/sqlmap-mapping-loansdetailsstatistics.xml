<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.mapper.LoansdetailsstatisticsMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志  -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="loansdetailsstatisticsMap" type="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.model.LoansdetailsEntity">
		<result property="qymc" column="qymc" />
		<result property="sdsj" column="sdsj" />
		<result property="sdyh" column="sdyh" />
		<result property="sdje" column="sdje" />
		<result property="hpzt" column="hpzt" />
		<result property="spsj" column="spsj" />
		<result property="sxje" column="sxje" />
		<result property="sxll" column="sxll" />
		<result property="hymc" column="hymc" />
		<result property="hydm" column="hydm" />
	</resultMap>
	
	<resultMap id="loantStatusMap" type="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.model.LoansdetailsEntity">
		<result property="hpzt" column="las_name" />
		<result property="hpztdesc" column="las_nameDes" />
	</resultMap>
	<select id="queryLoanStatus" resultMap="loantStatusMap">
		select las.las_name,las.las_name as las_nameDes from tb_loan_approve_status las where las.las_id in(1,3,4,5,7,9)
	</select>
	<!-- modify by xiecui 2018/04/02 begin -->
	<select id="loansdetailsstatistics_dat" parameterType="map" resultMap="loansdetailsstatisticsMap" flushCache="true" useCache="true">
		select *
		from (select
			nx.nsryhxx_swjgdm, 
			nx.nsryhxx_qymc qymc,
			DATE_FORMAT(la.la_apply_time, '%Y-%m-%d') sdsj,
			org.org_name sdyh,
			ROUND(ifnull(la.la_amount,0) , 2) sdje,
			las.las_name hpzt,
			DATE_FORMAT(temp2.updatetime, '%Y-%m-%d') spsj,
			ROUND(ifnull(temp2.lar_credit_quota,0) , 2) sxje,
			temp2.lar_rate sxll,
			case h.hy_dlbz
			when 'Y' then h.hy_mc
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_mc
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_mc
								when 'N' then (
									select  h4.hy_mc
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm 
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm 
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm ) 
			end hymc,
			case h.hy_dlbz
			when 'Y' then h.hy_dm
			when 'N' then (select case h2.hy_dlbz 
							when 'Y' then  h2.hy_dm
							when 'N' then (
								select  case h3.hy_dlbz
								when 'Y' then  h3.hy_dm
								when 'N' then (
									select  h4.hy_dm
									from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm 
								)
								end
								from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm 
							)
							end
						 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm ) 
			end hydm
			
		<!-- from 
			tb_loan_apply la
			left join tb_nsryhxx nx on la.creatorid=nx.creatorid
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
			left join tb_financial_product fp on la.fp_id=fp.fp_id
			left join tb_organizations org on fp.org_id=org.org_id -->	
			
			
		from  
			tb_nsryhxx nx 
		left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
		left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
        join tb_loan_apply la on ((la.nsrsbh=nx.nsryhxx_nsrsbh and la.nsrsbh!='') or (nx.nsryhxx_shtyxydm = la.nsrsbh and la.nsrsbh!='')) and n.enabled='Y'
		left join tb_financial_product fp on la.fp_id=fp.fp_id	
		left join tb_organizations org on fp.org_id=org.org_id
			
			
			left join  
				(<!-- select 
						tb_loan_approve_rec.lar_id,
						tb_loan_approve_rec.region_id,
						tb_loan_approve_rec.fp_id,
						tb_loan_approve_rec.la_id,
						tb_loan_approve_rec.las_id,
						tb_loan_approve_rec.lar_credit_quota,
						tb_loan_approve_rec.lar_loan_deadline,
						tb_loan_approve_rec.lar_rate,
						tb_loan_approve_rec.updatetime,
						tb_loan_approve_rec.lar_bank_name
					from 
						tb_loan_approve_rec
						join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id		
						join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
						join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
					where
						tb_loan_approve_rec.las_id =3 -->
		select tar.la_id,tar.lar_credit_quota,tar.updatetime,tar.lar_rate
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
		and ((ta.nsrsbh=nsrxx.nsryhxx_nsrsbh and ta.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = ta.nsrsbh and ta.nsrsbh!=''))
		and nsr.enabled='Y' and tar.las_id ='DKZT03' group by tar.lar_id
						)
			 		temp2 on temp2.la_id=la.la_id
			left join tb_loan_approve_status las on las.las_id=la.la_status
			<!-- left join tb_province_cities pc on 
			SUBSTR(pc.pc_code,1,6)=SUBSTR(nx.nsryhxx_swjgdm,2,6)	 -->
		
		<!-- <if test="enterprisename !=null and enterprisename != ''">
				and nx.nsryhxx_qymc like CONCAT('%',#{enterprisename},'%')
			</if>
			<if test="corporate !=null and corporate != ''">
				and org.org_name  like CONCAT('%',#{corporate},'%')
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			</if>
			
			<if test="approve !=null and approve != ''">
				and las.las_name = #{approve}
			</if> -->
		<where>
			<if test="enterprisename !=null and enterprisename != ''">
				nx.nsryhxx_qymc like CONCAT('%',#{enterprisename},'%')
			</if>
			<if test="corporate !=null and corporate != ''">
				and org.org_name  like CONCAT('%',#{corporate},'%')
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
				and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
			
			<if test="approve !=null and approve != ''">
				and las.las_name = #{approve}
			</if>
			<!-- <if test="pcId !=null and pcId !='' ">
				and (pc.pc_id = #{pcId} or pc.pc_pid = #{pcId}
				or pc.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} ))
			</if> -->	
		</where>
		 ORDER BY la.la_apply_time DESC )	e
		
		<where>
			exists (select 1 from tb_province_cities pc where			
		<if test="province !=null and city==null and area==null">
			SUBSTR(pc.pc_code,1,2)=SUBSTR(e.nsryhxx_swjgdm,2,2)
		</if>
		<if test="province !=null and province !='' and city!=null and area==null" >
			<if test="isChongQing != null and isChongQing == 'yes'">
				SUBSTR(pc.pc_code,1,6)=SUBSTR(e.nsryhxx_swjgdm,2,6)
        	</if>
         	<if test="isChongQing != null and isChongQing == 'no'">
            	SUBSTR(pc.pc_code,1,4)=SUBSTR(e.nsryhxx_swjgdm,2,4)
           	</if>
		</if>
		<if test="area !=null and area !='' ">
			SUBSTR(pc.pc_code,1,6)=SUBSTR(e.nsryhxx_swjgdm,2,6)
		</if>
			and (pc.pc_id = #{pcId} or pc.pc_pid = #{pcId}
				or pc.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} ))
			<if test="industries !=null and industries != '' and industries !='00'">
				and e.hydm = #{industries}
			</if>
			<if test="industries=='00'">
				and isnull(e.hydm)
			</if>
	 		<if test="hydm == '00'">
		    	and isnull(e.hymc)
		    </if>
		    ) 	    
		</where>		
	</select>
	
	
	<select id="loansdetailsstatistics_bef" parameterType="map" resultMap="loansdetailsstatisticsMap" flushCache="true" useCache="true">
		select *
			from (select
				nx.nsryhxx_swjgdm, 
				nx.nsryhxx_qymc qymc,
				DATE_FORMAT(la.la_apply_time, '%Y-%m-%d') sdsj,
				org.org_name sdyh,
				ROUND(ifnull(la.la_amount,0) , 2) sdje,
				las.las_name hpzt,
				DATE_FORMAT(temp2.updatetime, '%Y-%m-%d') spsj,
				ROUND(ifnull(temp2.lar_credit_quota,0) , 2) sxje,
				temp2.lar_rate sxll,
				case h.hy_dlbz
				when 'Y' then h.hy_mc
				when 'N' then (select case h2.hy_dlbz 
								when 'Y' then  h2.hy_mc
								when 'N' then (
									select  case h3.hy_dlbz
									when 'Y' then  h3.hy_mc
									when 'N' then (
										select  h4.hy_mc
										from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm 
									)
									end
									from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm 
								)
								end
							 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm ) 
				end hymc,
				case h.hy_dlbz
				when 'Y' then h.hy_dm
				when 'N' then (select case h2.hy_dlbz 
								when 'Y' then  h2.hy_dm
								when 'N' then (
									select  case h3.hy_dlbz
									when 'Y' then  h3.hy_dm
									when 'N' then (
										select  h4.hy_dm
										from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm 
									)
									end
									from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm 
								)
								end
							 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm ) 
				end hydm
			from  
				tb_nsryhxx nx 
			left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
	    join tb_loan_apply la on la.nsrsbh=nx.nsryhxx_nsrsbh and n.enabled='Y'
	
			left join tb_financial_product fp on la.fp_id=fp.fp_id	
			left join tb_organizations org on fp.org_id=org.org_id
			left join  
				(
				select tar.la_id,tar.lar_credit_quota,tar.updatetime,tar.lar_rate
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03' group by tar.lar_id
	
				union all 
	
				select tar.la_id,tar.lar_credit_quota,tar.updatetime,tar.lar_rate
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03' group by tar.lar_id
				
				)temp2 on temp2.la_id=la.la_id
				left join tb_loan_approve_status las on las.las_id=la.la_status	
				<where>
				<if test="enterprisename !=null and enterprisename != ''">
					nx.nsryhxx_qymc like CONCAT('%',#{enterprisename},'%')
				</if>
				<if test="corporate !=null and corporate != ''">
					and org.org_name  like CONCAT('%',#{corporate},'%')
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				<if test="approve !=null and approve != ''">
					and las.las_name = #{approve}
				</if>
			</where>
			 ORDER BY la.la_apply_time DESC )	e
			
			<where>
				exists (select 1 from tb_province_cities pc where			
				<if test="province !=null and city==null and area==null">
				SUBSTR(pc.pc_code,1,2)=SUBSTR(e.nsryhxx_swjgdm,2,2)
			</if>
			<if test="province !=null and province !='' and city!=null and area==null" >
				<if test="isChongQing != null and isChongQing == 'yes'">
					SUBSTR(pc.pc_code,1,6)=SUBSTR(e.nsryhxx_swjgdm,2,6)
	        	</if>
	         	<if test="isChongQing != null and isChongQing == 'no'">
	            	SUBSTR(pc.pc_code,1,4)=SUBSTR(e.nsryhxx_swjgdm,2,4)
	           	</if>
			</if>
			<if test="area !=null and area !='' ">
				SUBSTR(pc.pc_code,1,6)=SUBSTR(e.nsryhxx_swjgdm,2,6)
			</if>
			and (pc.pc_id = #{pcId} or pc.pc_pid = #{pcId}
							or pc.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} ))
						<if test="industries !=null and industries != '' and industries !='00'">
							and e.hydm = #{industries}
						</if>
						<if test="industries=='00'">
							and isnull(e.hydm)
						</if>
						<if test="hydm == '00'">
								and isnull(e.hymc)
							</if>
			    ) 
		</where>
	union ALL
	select *
			from (select
				nx.nsryhxx_swjgdm, 
				nx.nsryhxx_qymc qymc,
				DATE_FORMAT(la.la_apply_time, '%Y-%m-%d') sdsj,
				org.org_name sdyh,
				ROUND(ifnull(la.la_amount,0) , 2) sdje,
				las.las_name hpzt,
				DATE_FORMAT(temp2.updatetime, '%Y-%m-%d') spsj,
				ROUND(ifnull(temp2.lar_credit_quota,0) , 2) sxje,
				temp2.lar_rate sxll,
				case h.hy_dlbz
				when 'Y' then h.hy_mc
				when 'N' then (select case h2.hy_dlbz 
								when 'Y' then  h2.hy_mc
								when 'N' then (
									select  case h3.hy_dlbz
									when 'Y' then  h3.hy_mc
									when 'N' then (
										select  h4.hy_mc
										from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm 
									)
									end
									from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm 
								)
								end
							 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm ) 
				end hymc,
				case h.hy_dlbz
				when 'Y' then h.hy_dm
				when 'N' then (select case h2.hy_dlbz 
								when 'Y' then  h2.hy_dm
								when 'N' then (
									select  case h3.hy_dlbz
									when 'Y' then  h3.hy_dm
									when 'N' then (
										select  h4.hy_dm
										from tb_hydm h4 where h4.hy_dm=h3.hy_sjhydm 
									)
									end
									from tb_hydm h3 where h3.hy_dm=h2.hy_sjhydm 
								)
								end
							 from tb_hydm h2 where h2.hy_dm= h.hy_sjhydm ) 
				end hydm
			from  
				tb_nsryhxx nx 
			left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id
			left join tb_hydm h on h.hy_dm=nx.nsryhxx_hydm
	    join tb_loan_apply la on nx.nsryhxx_shtyxydm = la.nsrsbh and n.enabled='Y'
	
			left join tb_financial_product fp on la.fp_id=fp.fp_id	
			left join tb_organizations org on fp.org_id=org.org_id
			left join  
				(
				select tar.la_id,tar.lar_credit_quota,tar.updatetime,tar.lar_rate
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03' group by tar.lar_id
	
				union all 
	
				select tar.la_id,tar.lar_credit_quota,tar.updatetime,tar.lar_rate
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_nsryhxx nsrxx,tb_loan_apply_final taf,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and ta.la_id=taf.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03' group by tar.lar_id
				
				)temp2 on temp2.la_id=la.la_id
				left join tb_loan_approve_status las on las.las_id=la.la_status	
				<where>
				<if test="enterprisename !=null and enterprisename != ''">
					nx.nsryhxx_qymc like CONCAT('%',#{enterprisename},'%')
				</if>
				<if test="corporate !=null and corporate != ''">
					and org.org_name  like CONCAT('%',#{corporate},'%')
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				
				<if test="approve !=null and approve != ''">
					and las.las_name = #{approve}
				</if>
			</where>
			 ORDER BY la.la_apply_time DESC )	e
			
			<where>
				exists (select 1 from tb_province_cities pc where			
				<if test="province !=null and city==null and area==null">
				SUBSTR(pc.pc_code,1,2)=SUBSTR(e.nsryhxx_swjgdm,2,2)
			</if>
			<if test="province !=null and province !='' and city!=null and area==null" >
				<if test="isChongQing != null and isChongQing == 'yes'">
					SUBSTR(pc.pc_code,1,6)=SUBSTR(e.nsryhxx_swjgdm,2,6)
	        	</if>
	         	<if test="isChongQing != null and isChongQing == 'no'">
	            	SUBSTR(pc.pc_code,1,4)=SUBSTR(e.nsryhxx_swjgdm,2,4)
	           	</if>
			</if>
			<if test="area !=null and area !='' ">
				SUBSTR(pc.pc_code,1,6)=SUBSTR(e.nsryhxx_swjgdm,2,6)
			</if>
			and (pc.pc_id = #{pcId} or pc.pc_pid = #{pcId}
							or pc.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} ))
						<if test="industries !=null and industries != '' and industries !='00'">
							and e.hydm = #{industries}
						</if>
						<if test="industries=='00'">
							and isnull(e.hydm)
						</if>
						<if test="hydm == '00'">
								and isnull(e.hymc)
							</if>
			    ) 
		</where>		
	</select>
	<!-- modify by xiecui 2018/04/02 begin -->
	
	<select id="loansdetailsstatistics" parameterType="map" resultMap="loansdetailsstatisticsMap" flushCache="true" useCache="true">
		SELECT loandetail.`swjgdm` AS nsryhxx_swjgdm,ifnull(loandetail.`qymc`,'') AS qymc,ifnull(loandetail.`sdrq`,'') AS sdsj,ifnull(loandetail.`sdyh`,'') AS sdyh,ifnull(loandetail.`sdje`,'') AS sdje,ifnull(loandetail.`hpzt`,'') AS hpzt,ifnull(loandetail.`sxrq`,'') AS spsj,ifnull(loandetail.`sxje`,0) AS sxje,ifnull(loandetail.`sxll`,'') AS sxll,
		loandetail.`hymc_dl` AS hymc,loandetail.`hydm_dl` AS hydm
		FROM `tb_statistics_loandetail` loandetail
		<where>
			<if test="province !=null and province !='' and city==null">
				and loandetail.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
				<if test="isChongQing != null and isChongQing == 'yes'">
					and loandetail.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
				</if>
				<if test="isChongQing != null and isChongQing == 'no'">
					and loandetail.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
				</if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and loandetail.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			<if test="industries !=null and industries != '' and industries !='00'">
				and loandetail.`hydm_dl` = #{industries}
			</if>
			<if test="industries=='00'">
				and isnull(loandetail.`hydm_dl`)
			</if>
			<if test="hydm == '00'">
					and isnull(loandetail.`hymc_dl`)
			</if>
			<if test="enterprisename !=null and enterprisename != ''">
				loandetail.`qymc` like CONCAT('%',#{enterprisename},'%')
			</if>
			<if test="corporate !=null and corporate != ''">
				and loandetail.`sdyh`  like CONCAT('%',#{corporate},'%')
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(loandetail.`sdrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
			
			<if test="approve !=null and approve != ''">
				and loandetail.`hpzt` = #{approve}
			</if>
		</where>
		ORDER BY UNIX_TIMESTAMP(loandetail.`sdrq`) DESC	
	</select>
</mapper>