<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.count.mapper.PandectMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="pandectMap" type="com.dcits.govsbu.sd.taxbankplatform.count.model.PandectEntity">
		<result property="countName" column="countName" />
		<result property="month" column="month" />
		<result property="count" column="count" />
	</resultMap>
	<resultMap id="dataCountMap" type="com.dcits.govsbu.sd.taxbankplatform.count.model.DataCountEntity">
		<result property="dataName" column="dataName" />
		<result property="dataCount" column="dataCount" />
	</resultMap>
	
	<select id="searchByRegionId" parameterType="String" resultMap="pandectMap" flushCache="true" useCache="true">
		select 
			DATE_FORMAT(r_create_time,'%Y-%m') as month,
			count(*) as count
	    from 
	    	tb_role   
	    where 
	    	DATE_FORMAT(r_create_time,'%Y')='2016'   
	    group by month   
	    order by month
	</select>
	
	<!-- 将查询出的用户列表数据 -->
	<select id="findDataCount" parameterType="map" resultMap="dataCountMap" flushCache="true" useCache="true">
		select 
			'r'dataName,
			ifnull(count(distinct tb_loan_apply.creatorid),0) dataCount 
		from 
			tb_loan_apply 
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
		union all
		select 
			'la-1',
			ifnull(count(distinct tb_loan_apply.creatorid),0) 
		from 
			tb_loan_apply 
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_apply.la_status in ('DKZT03','DKZT07')
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
		union all
		select 
			'la',
			ifnull(count(*),0) 
		from 
			tb_loan_apply 
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
		union all
		select 
			'la_amou',
			ifnull(sum(tb_loan_apply.la_amount),0) 
		from 
			tb_loan_apply 
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
		union all
		select 
			'lar',
			ifnull(count(tb_loan_approve_rec.la_id),0) 
		from 
			tb_loan_approve_rec
			join tb_regions on tb_regions.region_id=tb_loan_approve_rec.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_approve_rec.las_id=3
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
		union all
		select 
			'lar_amou',
			ifnull(sum(tb_loan_approve_rec.lar_credit_quota),0) 
		from 
			tb_loan_approve_rec
			join tb_regions on tb_regions.region_id=tb_loan_approve_rec.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_approve_rec.las_id=3
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
		union all
		select 
			'report',
			ifnull(sum(tb_downloads_report.totaldowns),0)
		from 
			tb_downloads_report
			join tb_regions on tb_regions.region_id=tb_downloads_report.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_organizations org on org.org_id=tb_downloads_report.org_id
		<where>
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>
	</select>
	
	<!-- 查询近六个月用户列表数据 -->
	<select id="findDataCountByMonth" parameterType="map" resultMap="pandectMap" flushCache="true" useCache="true">
		select * 
		from (select 
			'r' countName, 
			ifnull(DATE_FORMAT(tb_loan_apply.la_apply_time, '%Y-%m'),'0000-00') month,
			ifnull(count(distinct tb_loan_apply.nsrsbh ),0) count 
		from  
			tb_loan_apply
			join tb_nsryhxx on tb_nsryhxx.nsryhxx_nsrsbh=tb_loan_apply.nsrsbh
			join tb_nsryh on tb_nsryh.nsryhxx_id=tb_nsryhxx.nsryhxx_id
			join tb_regions on tb_regions.region_id=tb_nsryh.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_apply.la_apply_time between date_sub(now(),interval 6 month) and now() 
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>) a
		group by a.month
		union all
		select *
		from (select 
			'la-1', 
			ifnull(DATE_FORMAT(tb_loan_apply_final.createtime, '%Y-%m'),'0000-00') dateb,
			ifnull(count(distinct tb_loan_apply.nsrsbh),0) 
		from 
			tb_loan_apply
			join tb_loan_apply_final on tb_loan_apply_final.la_id=tb_loan_apply.la_id
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_apply_final.createtime between date_sub(now(),interval 6 month) and now() 
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>) b
		group by b.dateb
		union all
		select *
		from (select 
			'la', 
			ifnull(DATE_FORMAT(tb_loan_apply.createtime, '%Y-%m'),'0000-00') datec,
			ifnull(count(*) ,0)
		from 
			tb_loan_apply
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_apply.createtime between date_sub(now(),interval 6 month) and now() 
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>) c
		group by c.datec
		union all
		select *
		from (select 
			'la_amou', 
			ifnull(DATE_FORMAT(tb_loan_apply.la_apply_time, '%Y-%m'),'0000-00') dated,
			ifnull(sum(tb_loan_apply.la_amount),0) 
		from 
			tb_loan_apply
			join tb_regions on tb_regions.region_id=tb_loan_apply.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_apply.createtime between date_sub(now(),interval 6 month) and now() 
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>) d
		group by d.dated
		union all
		select *
		from (select 
			'lar', 
			ifnull(DATE_FORMAT(tb_loan_approve_rec.updatetime, '%Y-%m'),'0000-00') datee,
			ifnull(count(tb_loan_approve_rec.lar_id),0) 
		from 
			tb_loan_approve_rec
			join tb_regions on tb_regions.region_id=tb_loan_approve_rec.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_approve_rec.las_id=3 
			and tb_loan_approve_rec.updatetime between date_sub(now(),interval 6 month) and now() 
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>) e
		group by e.datee
		union all
		select * 
		from (select 
			'lar_ammou', 
			ifnull(DATE_FORMAT(tb_loan_approve_rec.updatetime, '%Y-%m'),'0000-00') datef,
			ifnull(sum(tb_loan_approve_rec.lar_credit_quota),0) 
		from 
			tb_loan_approve_rec
			join tb_regions on tb_regions.region_id=tb_loan_approve_rec.region_id
			join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
			join tb_loan_apply on tb_loan_approve_rec.la_id=tb_loan_apply.la_id
			join tb_financial_product fp on fp.fp_id=tb_loan_apply.fp_id
			join tb_organizations org on org.org_id=fp.org_id
		<where>
			tb_loan_approve_rec.las_id=3 
			and tb_loan_approve_rec.updatetime between date_sub(now(),interval 6 month) and now() 
			<if test="pcId != null and pcId != ''">
				and (tb_province_cities.pc_id = #{pcId} 
					or tb_province_cities.pc_pid = #{pcId}
					or tb_province_cities.pc_pid in 
						(select 
							pcs.pc_id 
						from 
							tb_province_cities pcs 
						where 
							pcs.pc_pid = #{pcId} ))
			</if>
			<if test="orgId != null and orgId != ''">
				and (org.org_id = #{orgId}
					or org.up_org_id = #{orgId}
					or org.up_org_id  in 
						(select 
							org1.org_id
						from 
							tb_organizations org1
						where 
							org1.up_org_id = #{orgId} ))
			</if>
		</where>) f
		group by f.datef
		union all
		select *
		from (select 
					'report', 
					ifnull(DATE_FORMAT(down_time, '%Y-%m'),'0000-00') dateg,
					ifnull(sum(tb_downloads_report.totaldowns),0)
				from 
					tb_downloads_report
					join tb_regions on tb_regions.region_id=tb_downloads_report.region_id
					join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
					join tb_organizations org on org.org_id=tb_downloads_report.org_id
				<where>
					<if test="pcId != null and pcId != ''">
						tb_province_cities.pc_id = #{pcId} 
							or tb_province_cities.pc_pid = #{pcId}
							or tb_province_cities.pc_pid in 
								(select 
									pcs.pc_id 
								from 
									tb_province_cities pcs 
								where 
									pcs.pc_pid = #{pcId} )
					</if>
					<if test="orgId != null and orgId != ''">
						and (org.org_id = #{orgId}
							or org.up_org_id = #{orgId}
							or org.up_org_id  in 
								(select 
									org1.org_id
								from 
									tb_organizations org1
								where 
									org1.up_org_id = #{orgId} ))
					</if>
				</where>) g
			group by g.dateg
	</select>
</mapper>