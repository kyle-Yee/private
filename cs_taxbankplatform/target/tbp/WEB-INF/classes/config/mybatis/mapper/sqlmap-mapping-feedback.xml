<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.tbpStatic.mapper.FeedbackMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	<!-- <cache type="org.mybatis.caches.ehcache.EhcacheCache"/> -->
	
	<resultMap id="feedbackMap" type="com.dcits.govsbu.sd.taxbankplatform.tbpStatic.model.FeedbackEntity">
		<id property="id" column="f_id"/>
		<result property="cityId" column="region_id" />
		<result property="cityName" column="region_name" />
		<result property="feedbackContent" column="f_content" />
		<result property="enabled" column="enabled"/>
		<result property="feedbackName" column="f_title"/>
		<result property="creatorid" column="creatorid"/>
		<result property="createtime" column="createtime"/>
		<result property="updatorid" column="updatorid"/>
		<result property="updatetime" column="updatetime"/>
		<result property="status" column="status"/>
		<result property="lasttime" column="lasttime"/>
		<result property="tel" column="tel"/>
		<result property="qq" column="qq"/>
		<result property="email" column="email"/>
		<result property="showfeed" column="showfeed"/>
	</resultMap>

	<!-- 搜索数据 -->
	<select id="queryListByPage" parameterType="map" resultMap="feedbackMap" flushCache="true" useCache="true">
		SELECT
		f.f_id,
		f.f_content,
		f.f_title,
		f.enabled,
		r.region_name,
		f.status,
		f.lasttime
		FROM tb_feedback f LEFT JOIN tb_regions r ON f.region_id = r.region_id
		<where>
			<if test="feedbackName != null and feedbackName != ''">
			f.f_title LIKE CONCAT('%','${feedbackName}','%' )
			</if>
			and f.region_id = #{cityId} and showfeed = 1
		</where>
	</select>

	<!-- 点击编辑按钮时候查询单条数据 -->
	<select id="findById" parameterType="String" resultMap="feedbackMap" flushCache="true" useCache="true">
		SELECT
		f.f_id,
		f.f_content,
		f.f_title,
		f.enabled,
		r.region_name,
		f.status,
		f.lasttime
		FROM tb_feedback f LEFT JOIN tb_regions r ON f.region_id = r.region_id
		where f.f_id = #{id}
	</select>

	<!-- 插入数据 -->
	<insert id="insert" parameterType="com.dcits.govsbu.sd.taxbankplatform.tbpStatic.model.FeedbackEntity">
		insert into tb_feedback (
			f_id,region_id,f_title,f_content,enabled,creatorid,createtime,updatorid,updatetime
			)   
		values (
			#{id},
			#{cityId},
			#{feedbackName},
			#{feedbackContent},
			#{enabled},
			#{creatorid},
			#{createtime},
			#{updatorid},
			#{updatetime}
			)  
	</insert>
	
	<!-- 更新数据 -->
	<update id="update" parameterType="com.dcits.govsbu.sd.taxbankplatform.tbpStatic.model.FeedbackEntity" flushCache="true">
		update tb_feedback
		<set>
			<if test="enabled != null and enabled != ''">
				enabled = #{enabled},
			</if>
			<if test="status != 0">
				status = #{status},
			</if>
			<if test="lasttime != null">
				lasttime = #{lasttime},
			</if>
			updatorid = #{updatorid},
			updatetime = now()
		</set>
		where f_id = #{id}
	</update>
	
	
	<!-- **************************dialog部分**************************** -->
	<resultMap id="dialogMap" type="com.dcits.govsbu.sd.taxbankplatform.tbpStatic.model.DialogEntity">
		<id property="dia_id" column="dia_id"/>
		<result property="f_id" column="f_id"/>
		<result property="f_content" column="f_content"/>
		<result property="creatorid" column="creatorid"/>
		<result property="createtime" column="createtime"/>
		<result property="type" column="type"/>
	</resultMap>
	
	
	<sql id="dialogEntity">
		dia_id,f_id,f_content,creatorid,createtime,type	
	</sql>
	
	<!-- 插入对话DialogEntity -->
	<insert id="insertDialog" parameterType="com.dcits.govsbu.sd.taxbankplatform.tbpStatic.model.DialogEntity">
		INSERT INTO tb_feedback_dialog (dia_id,f_id,f_content,creatorid,createtime,type) VALUES (#{id},#{f_id},#{f_content},#{creatorid},#{createtime},#{type});
	</insert>
	
	
	<!-- 根据问题id获取对话列表 -->
	<select id="dialogList" parameterType="String" resultMap="dialogMap">
		SELECT 
			<include refid="dialogEntity"/>
		 FROM 
		 	tb_feedback_dialog 
		 WHERE 
		 	f_id = #{questionId}
		 order by dia_id;
	</select>
	
	<select id="getNameByAdminId" parameterType="String" resultType="java.lang.String">
		SELECT u_name FROM tb_user WHERE u_id=#{intValue};
	</select>
	
	<select id="getNameByUserId" parameterType="String" resultType="java.lang.String">
		SELECT nsryh_name FROM tb_nsryh WHERE nsryh_id=#{intValue};
	</select>

</mapper>