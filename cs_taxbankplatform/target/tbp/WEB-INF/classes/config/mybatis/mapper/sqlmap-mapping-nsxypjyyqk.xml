<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.statisticalanalysis.mapper.NsxypjyyqkMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="actualissuanceLoansMap" type="com.dcits.govsbu.sd.taxbankplatform.statisticalanalysis.model.NsxypjyyqkEntity">
	<result property="totalamount" column="totalamount" />
		<result property="swjgtsyhA" column="swjgtsyhA" />
		<result property="swjgtsyhB" column="swjgtsyhB" />
		<result property="swjgtsyhC" column="swjgtsyhC" />
		<result property="swjgtsyhW" column="swjgtsyhW" />
		<result property="swjgtsyhH" column="swjgtsyhH" />
		 
		
		<result property="qzsxhsA" column="qzsxhsA" />
		<result property="qzsxhsB" column="qzsxhsB" />
		<result property="qzsxhsC" column="qzsxhsC" />
		<result property="qzsxhsD" column="qzsxhsD" />
		<result property="qzsxhsW" column="qzsxhsW" />
		<result property="qzsxhsH" column="qzsxhsH" />
		
		
		<result property="qztzxhsA" column="qztzxhsA" />
		<result property="qztzxhsB" column="qztzxhsB" />
		<result property="qztzxhsC" column="qztzxhsC" />
		<result property="qztzxhsD" column="qztzxhsD" />
		<result property="qztzxhsW" column="qztzxhsW" />
		<result property="qztzxhsH" column="qztzxhsH" />
		
		<result property="jjjyrs" column="jjjyrs" />
		 
	</resultMap>
	<select id="findHy"   resultType="map" flushCache="true" useCache="true">
	 	select hy_dm,hy_mc from tb_hydm where hy_dlbz = 'Y'
	 	</select>
	<!-- 银税互动，统计分析表 -->

 
	<select id="sjtsyhs_bef" parameterType="map" resultType="map" flushCache="true" useCache="true">
	select 	COUNT(o.nsrsbh) as swjgtsyh ,o.nsryhxx_xydj  from (
	SELECT
	COUNT(k.nsrsbh) as yhs,k.nsrsbh,b.nsryhxx_xydj
	FROM
		tb_downloads_report w
	LEFT JOIN tb_loan_apply k ON w.la_id = k.la_id
	LEFT JOIN tb_nsryhxx b ON k.nsrsbh=b.nsryhxx_nsrsbh 
  	LEFT JOIN tb_nsryh j ON b.nsryhxx_id = j.nsryhxx_id and j.enabled = 'Y'
	LEFT JOIN tb_regions c ON w.region_id = c.region_id
	LEFT JOIN tb_province_cities d ON d.pc_code = c.region_code  
	<where>
    <if test="start != null and start != '' and end != null and end != ''">
     and  date_format(w.down_time, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
    </if>
     
     <if test="pcId!=null and pcId!=''">
		and ( d.pc_pid = #{pcId}   or  d.pc_id = #{pcId}
				or d.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )) 
		   
	 </if>
  	  <if test="hyDm != 'all' and hyDm != 'qt'">
  	   and  b.nsryhxx_hydm in(${hyDm})
  	  </if>
  	  <if test=" hyDm == 'qt'">
  	    and   (b.nsryhxx_hydm IS NULL or b.nsryhxx_hydm = '')
  	  </if>
  	   </where> 
  	    group by k.nsrsbh
  	    
  	 union all
  	 
  	 SELECT
	COUNT(k.nsrsbh) as yhs,k.nsrsbh,b.nsryhxx_xydj
	FROM
		tb_downloads_report w
	LEFT JOIN tb_loan_apply k ON w.la_id = k.la_id
	LEFT JOIN tb_nsryhxx b ON b.nsryhxx_shtyxydm = k.nsrsbh 
  	LEFT JOIN tb_nsryh j ON b.nsryhxx_id = j.nsryhxx_id and j.enabled = 'Y'
	LEFT JOIN tb_regions c ON w.region_id = c.region_id
	LEFT JOIN tb_province_cities d ON d.pc_code = c.region_code  
	<where>
    <if test="start != null and start != '' and end != null and end != ''">
     and  date_format(w.down_time, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
    </if>
     
     <if test="pcId!=null and pcId!=''">
		and ( d.pc_pid = #{pcId}   or  d.pc_id = #{pcId}
				or d.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )) 
		   
	 </if>
  	  <if test="hyDm != 'all' and hyDm != 'qt'">
  	   and  b.nsryhxx_hydm in(${hyDm})
  	  </if>
  	  <if test=" hyDm == 'qt'">
  	    and   (b.nsryhxx_hydm IS NULL or b.nsryhxx_hydm = '')
  	  </if>
  	   </where> 
  	    group by k.nsrsbh
  	   ) o
 	group by o.nsryhxx_xydj
	</select>
	
	<!-- modify by xiecui 2018/04/02 begin -->
	<select id="qzysxhs_dat" parameterType="map" resultType="map" flushCache="true" useCache="true">
	
	Select  h.nsryhxx_xydj,COUNT(h.nsrsbh) as qzsxhs from (
	
	select  sum(lafs_id),b.nsrsbh,d.nsryhxx_xydj from tb_loan_apply_final a 
	LEFT JOIN tb_loan_apply b  on a.la_id = b.la_id 
	LEFT JOIN tb_nsryhxx d  on (b.nsrsbh=d.nsryhxx_nsrsbh and b.nsrsbh!='') or (d.nsryhxx_shtyxydm = b.nsrsbh and b.nsrsbh!='')
	LEFT JOIN tb_nsryh m  on  d.nsryhxx_id=m.nsryhxx_id and m.enabled = 'Y'
	left join tb_regions c  on b.region_id = c.region_id
	left join tb_province_cities  e on e.pc_code=c.region_code 
	<!-- select  d.nsryhxx_xydj,COUNT(a.fp_id) as qzsxhs from tb_loan_apply_final a 
	LEFT JOIN tb_loan_apply b  on a.la_id = b.la_id 
	LEFT JOIN tb_nsryhxx d  on b.nsrsbh = d.nsryhxx_nsrsbh 
	left join tb_regions c  on b.region_id = c.region_id
	left join tb_province_cities  e on e.pc_code=c.region_code  -->
	
	<where>
    <if test="start != null and start != '' and end != null and end != ''">
     and  date_format(a.createtime, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
    </if>
     
     <if test="pcId!=null and pcId!=''">
		and ( e.pc_pid = #{pcId}   or  e.pc_id = #{pcId}
				or e.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )) 
		   
	 </if>
  	  <if test="hyDm != 'all' and hyDm != 'qt'">
  	   and  d.nsryhxx_hydm in(${hyDm})
  	  </if>
  	  <if test=" hyDm == 'qt'">
  	   and (d.nsryhxx_hydm IS NULL or d.nsryhxx_hydm = '')
  	  </if>
  	   </where> 
  	   
	GROUP BY  b.nsrsbh ) h
	GROUP BY h.nsryhxx_xydj
	</select>
	
	<select id="qzysxhs_bef" parameterType="map" resultType="map" flushCache="true" useCache="true">
	
	Select  h.nsryhxx_xydj,COUNT(h.nsrsbh) as qzsxhs from (
	
	select  sum(lafs_id),b.nsrsbh,d.nsryhxx_xydj from tb_loan_apply_final a 
	LEFT JOIN tb_loan_apply b  on a.la_id = b.la_id 
	LEFT JOIN tb_nsryhxx d  on b.nsrsbh=d.nsryhxx_nsrsbh 
	LEFT JOIN tb_nsryh m  on  d.nsryhxx_id=m.nsryhxx_id and m.enabled = 'Y'
	left join tb_regions c  on b.region_id = c.region_id
	left join tb_province_cities  e on e.pc_code=c.region_code 
	<where>
    <if test="start != null and start != '' and end != null and end != ''">
     and  date_format(a.createtime, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
    </if>
     
     <if test="pcId!=null and pcId!=''">
		and ( e.pc_pid = #{pcId}   or  e.pc_id = #{pcId}
				or e.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )) 
		   
	 </if>
  	  <if test="hyDm != 'all' and hyDm != 'qt'">
  	   and  d.nsryhxx_hydm in(${hyDm})
  	  </if>
  	  <if test=" hyDm == 'qt'">
  	   and (d.nsryhxx_hydm IS NULL or d.nsryhxx_hydm = '')
  	  </if>
  	   </where> 
	GROUP BY  b.nsrsbh 
	union all
	
	select  sum(lafs_id),b.nsrsbh,d.nsryhxx_xydj from tb_loan_apply_final a 
	LEFT JOIN tb_loan_apply b  on a.la_id = b.la_id 
	LEFT JOIN tb_nsryhxx d  on d.nsryhxx_shtyxydm = b.nsrsbh 
	LEFT JOIN tb_nsryh m  on  d.nsryhxx_id=m.nsryhxx_id and m.enabled = 'Y'
	left join tb_regions c  on b.region_id = c.region_id
	left join tb_province_cities  e on e.pc_code=c.region_code 
	<where>
    <if test="start != null and start != '' and end != null and end != ''">
     and  date_format(a.createtime, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
    </if>
     
     <if test="pcId!=null and pcId!=''">
		and ( e.pc_pid = #{pcId}   or  e.pc_id = #{pcId}
				or e.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} )) 
		   
	 </if>
  	  <if test="hyDm != 'all' and hyDm != 'qt'">
  	   and  d.nsryhxx_hydm in(${hyDm})
  	  </if>
  	  <if test=" hyDm == 'qt'">
  	   and (d.nsryhxx_hydm IS NULL or d.nsryhxx_hydm = '')
  	  </if>
  	   </where> 
	GROUP BY  b.nsrsbh 
	) h
	
	GROUP BY h.nsryhxx_xydj
	</select>
	
	<!-- modify by xiecui 2018/04/02-->
	
	<select id="findXlHyDm"  parameterType="java.lang.String" resultType="java.lang.String" >
	select   d.xl_hydm  from (select a.hy_dm as xl_hydm,a.hy_sjhydm from  tb_hydm a where a.hy_xlbz = 'Y' and a.hy_yxbz = 'Y') d  
	LEFT JOIN tb_hydm e  on d.hy_sjhydm = e.hy_dm  where e.hy_sjhydm = #{hydm}
	</select>
	
	<select id="findZlHyDm"  parameterType="java.lang.String" resultType="java.lang.String" >
	select   a.hy_dm  from  tb_hydm a where a.hy_sjhydm = #{hydm} and a.hy_yxbz = 'Y' 
	 
	</select>
	
	
	<select id="sjtsyhs" parameterType="map" resultType="map" flushCache="true" useCache="true">
		<!-- SELECT COUNT(nsxy.`swtsnsrsbh`) swjgtsyh,nsxy.`xydj` nsryhxx_xydj FROM `tb_statistics_nsxy` nsxy
		<where>
			<if test="start != null and start != '' and end != null and end != ''">
			 and  date_format(nsxy.`downtime`, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
			</if>
		   
		<if test="province !=null and province !='' and city==null">
			and nsxy.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and nsxy.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and nsxy.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and nsxy.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="hyDm != 'all' and hyDm != 'qt'">
		 	and  nsxy.`hydm` in(${hyDm})
		</if>
		<if test=" hyDm == 'qt'">
		 	 and   (nsxy.`hydm` IS NULL or nsxy.`hydm` = '')
		</if>
		</where>
		GROUP BY nsxy.`xydj` -->
		
		
	SELECT
	COUNT(DISTINCT IF(LENGTH(trim(a.ENTTAXID)) > 1, a.ENTTAXID, a.ENTCREDITID)) swjgtsyh,
	b.nsryhxx_xydj nsryhxx_xydj
FROM tb_loan_dksq a, tb_nsryhxx b
WHERE
	b.nsryhxx_nsrsbh = IF(LENGTH(trim(a.ENTTAXID)) > 1, a.ENTTAXID, a.ENTCREDITID)
OR b.nsryhxx_shtyxydm = IF(LENGTH(trim(a.ENTTAXID)) > 1, a.ENTTAXID, a.ENTCREDITID)
<if test="start != null and end != null">
	AND DATE_FORMAT(a.`APPLYTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{start},'%Y-%c-%d') AND DATE_FORMAT(#{end},'%Y-%c-%d')
</if>
<if test="hyDm != 'all' and hyDm != 'qt'">
	and b.`nsryhxx_hydm` = #{hyDm}
</if>
GROUP BY b.nsryhxx_xydj
	</select>
	
	
	<select id="qzysxhs" parameterType="map" resultType="map" flushCache="true" useCache="true">
		<!-- SELECT nsxy.`xydj` nsryhxx_xydj, COUNT(nsxy.`sxnsrsbh`) qzsxhs FROM `tb_statistics_nsxy` nsxy
		<where>
			<if test="start != null and start != '' and end != null and end != ''">
			 and  date_format(nsxy.`downtime`, '%Y-%c-%d') between date_format(#{start}, '%Y-%c-%d') and date_format(#{end}, '%Y-%c-%d')
			</if>
		   
		<if test="province !=null and province !='' and city==null">
			and nsxy.`swjgdm_p` in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and nsxy.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and nsxy.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and nsxy.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="hyDm != 'all' and hyDm != 'qt'">
		 and  nsxy.`hydm` in(${hyDm})
		</if>
		<if test=" hyDm == 'qt'">
		  and   (nsxy.`hydm` IS NULL or nsxy.`hydm` = '')
		</if>
		</where>
		GROUP BY nsxy.`xydj` -->
		SELECT
	COUNT(DISTINCT IF(LENGTH(trim(a.ENTTAXID)) > 1, a.ENTTAXID, a.ENTCREDITID)) qzsxhs,
	b.nsryhxx_xydj nsryhxx_xydj
FROM tb_loan_dhsx a, tb_nsryhxx b
WHERE
	b.nsryhxx_nsrsbh = IF(LENGTH(trim(a.ENTTAXID)) > 1, a.ENTTAXID, a.ENTCREDITID)
OR b.nsryhxx_shtyxydm = IF(LENGTH(trim(a.ENTTAXID)) > 1, a.ENTTAXID, a.ENTCREDITID)
<if test="start != null and end != null">
	AND DATE_FORMAT(a.`LOANGRANTTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{start},'%Y-%c-%d') AND DATE_FORMAT(#{end},'%Y-%c-%d')
</if>
<if test="hyDm != 'all' and hyDm != 'qt'">
	and b.`nsryhxx_hydm` = #{hyDm}
</if>
GROUP BY b.nsryhxx_xydj
	</select>
</mapper>