<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.count.mapper.QuerybyregionMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	<!--  
	<resultMap id="querybyregionMap" type="com.dcits.govsbu.sd.taxbankplatform.count.model.QuerybyregionEntity">
		<result property="month" column="month" />
		<result property="countRegister" column="countRegister" />
	</resultMap>
	-->
	
	<resultMap id="querybyregionMap" type="com.dcits.govsbu.sd.taxbankplatform.count.model.QuerybyregionEntity">
		<id property="id" column="ROWNO"/>
		<result property="banklist" column="banklist" />
		<result property="creditnumber" column="creditnumber"/>
		<result property="creditline" column="creditline"/>
		<result property="bgxzcs" column="bgxzcs"/>
		<result property="dqxzcs" column="dqxzcs"/>
		<result property="dhxzcs" column="dhxzcs"/>
		<!-- 报告下载次数-->
	</resultMap>
	
	
	<select id="queryListByPage" parameterType="map" resultMap="querybyregionMap" flushCache="true" useCache="true">
		select 
			max(org.org_name) banklist,
			count(lar.la_id ) creditnumber,
			ifnull(sum(lar.lar_credit_quota),0) creditline,
			ifnull(dr.bgxzcs,0) bgxzcs,
			ifnull(dr2.dqxzcs,0) dqxzcs,
			ifnull(dr3.dhxzcs,0) dhxzcs
			
		from tb_organizations org
			join tb_financial_product fp on fp.org_id=org.org_id
			left join tb_loan_approve_rec lar on lar.fp_id=fp.fp_id and lar.las_id=3
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and (date_format(lar.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d'))
				</if>
			left join (
					select 
						org_id,
						sum(totaldowns) bgxzcs
					from 
						tb_downloads_report 
					<where>
						<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
							date_format(tb_downloads_report.update_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
						</if>
					</where>
					group by org_id) dr 
			on dr.org_id=org.org_id
			
			left join (
					select 
						org_id,
						sum(totaldowns) dqxzcs 
					from 
						tb_downloads_report 
					<where> 
						tb_downloads_report.down_status=1
						<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
							and  date_format(tb_downloads_report.update_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
						</if> 
					</where>
					group by org_id) dr2 
			on dr2.org_id=org.org_id 		
			left join (
					select 
						org_id,
						sum(totaldowns) dhxzcs 
					from 
						tb_downloads_report 
					<where>
						tb_downloads_report.down_status=2 
						<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
							and  date_format(tb_downloads_report.update_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
						</if>
					</where>
					group by org_id) dr3 
			on dr3.org_id=org.org_id

			join tb_province_cities pc on pc.pc_id=org.pc_id
			<where>	
				<if test="subbranch != null and subbranch != ''">
					org.org_name like CONCAT('%',#{subbranch},'%')
				</if>
				<if test="orgId != null and orgId != ''">
					and (org.org_id = #{orgId}
						or org.up_org_id = #{orgId}
						or org.up_org_id  in 
							(select 
								org1.org_id
							from 
								tb_organizations org1
							where 
								org1.up_org_id = #{orgId} ))
				</if>	
				<if test="pcId != null and pcId != ''">
					and (pc.pc_id = #{pcId} 
						or pc.pc_pid = #{pcId}
						or pc.pc_pid in 
							(select 
								pcs.pc_id 
							from 
								tb_province_cities pcs 
							where 
								pcs.pc_pid = #{pcId} ))
				</if>
			</where>
		group by org.org_id									
	</select>
	
	<!-- <select id="searchByRegionId" parameterType="String" resultMap="querybyregionMap" flushCache="true" useCache="true">
		select 
			DATE_FORMAT(r_create_time,'%Y-%m') as month,
			count(*) as countRegister
			
	    from 
	    	tb_role   
	    	
	    where 
	    	DATE_FORMAT(r_create_time,'%Y')='2016'
	    	   
	    group by month   
	    order by month
	</select> -->
</mapper>