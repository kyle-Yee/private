<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.statisticalanalysis.mapper.ReportingMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志  -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="reportingMap" type="com.dcits.govsbu.sd.taxbankplatform.statisticalanalysis.model.ReportingEntity">
		<result property="area" column="area" />
		<result property="pcid" column="pcid" />
		<result property="zcyh" column="zcyh" />
		<result property="zqyzsbl" column="zqyzsbl" />
		<result property="rztgs" column="rztgs" />
		<result property="sxbs" column="sxbs" />
		<result property="sxze" column="sxze" />
	</resultMap>
<!-- 	<select id="reportingDetails" parameterType="map" resultMap="reportingMap" flushCache="true" useCache="true"> -->
<!-- 		select  -->
<!-- 			pc.pc_name area, -->
<!-- 			pc.pc_code pccode, -->
<!-- 			ifnull(count(distinct n.nsryh_id),0) zcyh, -->
<!-- 			ifnull(count(distinct n2.nsryh_id),0) rztgs, -->
<!-- 			ifnull(count(distinct la.la_id),0) sxbs, -->
<!-- 			ifnull(sum(lar.lar_credit_quota),0) sxze -->
<!-- 		from  -->
<!-- 			tb_province_cities pc -->
			
<!-- 			<if test="currentarea=='province'.toString()"> -->
<!-- 				left join tb_nsryhxx nx on substring(nx.nsryhxx_swjgdm,2,4) = substring(pc.pc_code,1,4) -->
<!-- 			</if> -->
<!-- 			<if test="currentarea=='city'.toString()"> -->
<!-- 				left join tb_nsryhxx nx on substring(nx.nsryhxx_swjgdm,2,6) = substring(pc.pc_code,1,6) -->
<!-- 			</if> -->
<!-- 			<if test="currentarea=='area'.toString()"> -->
<!-- 				left join tb_nsryhxx nx on substring(nx.nsryhxx_swjgdm,2,6) = substring(pc.pc_code,1,6) -->
<!-- 			</if> -->
<!-- 			left join tb_nsryh n on n.nsryhxx_id=nx.nsryhxx_id  -->
<!-- 			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''"> -->
<!-- 				and date_format(n.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
<!-- 			</if> -->
<!-- 			left join tb_nsryh n2 on n2.nsryhxx_id = nx.nsryhxx_id and n2.enabled = 'Y'  -->
<!-- 			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''"> -->
<!-- 				and date_format(n2.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
<!-- 			</if> -->
<!-- 			left join tb_loan_apply la on la.nsrsbh=nx.nsryhxx_nsrsbh and la.la_status in (3,7) -->
<!-- 			left join tb_loan_approve_rec lar on lar.la_id=la.la_id and lar.las_id=3 -->
<!-- 			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''"> -->
<!-- 				and date_format(lar.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')		 -->
<!-- 			</if> -->
			
<!-- 		<choose> -->
<!--             <when test="currentarea=='area'.toString()"> -->
<!--                    where pc.pc_id= #{pcId} -->
<!--             </when> -->
<!--             <otherwise> -->
<!--                    <where> -->
<!-- 	                   <if test="pcId != null and pcId != ''"> -->
<!-- 							pc.pc_pid= #{pcId} -->
<!-- 				       </if> -->
<!--                    </where> -->
<!--             </otherwise> -->
<!--          </choose>		 -->
<!-- 		group by  -->
<!-- 			pc.pc_name -->
<!-- 		order by  -->
<!-- 			pc.pc_id asc -->
<!-- 	</select> -->
	
	<select id="taxBankAnaDetails_bef" parameterType="map" resultMap="reportingMap" flushCache="true" useCache="true">
		<!-- modify by xiecui 2018/04/02 begin -->
		<!-- select tot.* from(
		select tta.tax_id taxid,tta.tax_name swjg,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rztgs,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze 
		from tb_tax_authority_code tta,
		(select tac.tax_id taxid,tac.tax_prc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,tac.swjbz from tb_tax_authority_code tac
		left join
		(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
		from tb_nsryhxx nsrxx 
		<if test="province !=null and province !='' and city==null">
			where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
		</if>
		group by nsrxx.nsryhxx_swjgdm) a
		on tac.tax_id=a.nsryhxx_swjgdm
		left join
		(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
		<if test="province !=null and province !='' and city==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
		</if>
		group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
		left join
		(select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
		from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
		and ((ta.nsrsbh=nsrxx.nsryhxx_nsrsbh and ta.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = ta.nsrsbh and ta.nsrsbh!=''))	
		and nsr.enabled='Y' and tar.las_id ='DKZT03'
		<if test="province !=null and province !='' and city==null">
			and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="province!=null and city!= null and area !=null and area !='' ">
			 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and  date_format(ta.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
		</if>
		group by nsrxx.nsryhxx_swjgdm) c
		on tac.tax_id= c.nsryhxx_swjgdm) cal
		where (tta.tax_id=cal.tax_prc_id and cal.swjbz='') or (tta.tax_id=cal.taxid and cal.swjbz in('Y','K'))
		or tta.tax_id =
		(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
		(select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =cal.taxid))
		group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot
		<if test="province !=null and province !='' and city==null">
			where substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
               where substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
               where substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			where  substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		and tot.swjbz in('Y','K') -->
		
		
		select max(t.taxid) taxid,max(t.swjg) swjg,max(t.swjbz) swjbz,sum(t.zcyh) zcyh,sum(t.rztgs) rztgs,sum(t.sxbs) sxbs,sum(t.sxze) sxze from 
		(select tot.* from(
				select tta.tax_id taxid,tta.tax_name swjg,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rztgs,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze 
				from tb_tax_authority_code tta,
				(select tac.tax_id taxid,tac.tax_prc_id,(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
				(select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =tac.tax_id)) tax_pprc_id,
				tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,tac.swjbz from tb_tax_authority_code tac
				left join
				(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
				from tb_nsryhxx nsrxx 
				<if test="province !=null and province !='' and city==null">
					where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
				</if>
				group by nsrxx.nsryhxx_swjgdm) a
				on tac.tax_id=a.nsryhxx_swjgdm
				left join
				(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
				<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
				</if>
		
				group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
				left join
				(select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
				<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm
				
				union all 
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh 
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
				<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm
				) c
				on tac.tax_id= c.nsryhxx_swjgdm) cal
				where tta.tax_id=cal.tax_prc_id and cal.swjbz=''
				group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot
				<if test="province !=null and province !='' and city==null">
					where substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		               where substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		               where substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="area !=null and area !='' ">
					where  substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				and tot.swjbz in('Y','K')
		
		union all 
		
		select tot.* from(
				select tta.tax_id taxid,tta.tax_name swjg,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rztgs,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze 
				from tb_tax_authority_code tta,
				(select tac.tax_id taxid,tac.tax_prc_id,(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
				(select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =tac.tax_id)) tax_pprc_id,
				tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,tac.swjbz from tb_tax_authority_code tac
				left join
				(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
				from tb_nsryhxx nsrxx 
					where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = 2292)
				group by nsrxx.nsryhxx_swjgdm) a
				on tac.tax_id=a.nsryhxx_swjgdm
				left join
				(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = 2292)
		
				group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
				left join
				(select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh	
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = 2292)
				group by nsrxx.nsryhxx_swjgdm
				
				union all 
		
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = 2292)
				group by nsrxx.nsryhxx_swjgdm
				) c
				on tac.tax_id= c.nsryhxx_swjgdm) cal
				where tta.tax_id=cal.taxid and cal.swjbz in('Y','K')
				group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot
					where substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = 2292)
				and tot.swjbz in('Y','K')
		
		union all 
		
		select tot.* from(
				select tta.tax_id taxid,tta.tax_name swjg,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rztgs,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze 
				from tb_tax_authority_code tta,
				(select tac.tax_id taxid,tac.tax_prc_id,(select tax_prc_id from tb_tax_authority_code tt where  tt.swjbz='' and tt.tax_id =
				(select tax_prc_id from tb_tax_authority_code where swjbz='' and tax_id =tac.tax_id)) tax_pprc_id,
				tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,tac.swjbz from tb_tax_authority_code tac
				left join
				(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm
				from tb_nsryhxx nsrxx 
				<if test="province !=null and province !='' and city==null">
					where substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              where substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 where substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
				</if>
				group by nsrxx.nsryhxx_swjgdm) a
				on tac.tax_id=a.nsryhxx_swjgdm
				left join
				(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
				<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
				</if>
		
				group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
				left join
				(select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and ta.nsrsbh=nsrxx.nsryhxx_nsrsbh	
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
				<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm
				union all 
				select round(IFNULL(sum(tar.lar_credit_quota),0),2) sxze,count(distinct tar.la_id) as sxbs, nsrxx.nsryhxx_swjgdm
				from tb_loan_approve_rec tar,tb_loan_apply ta,tb_loan_apply_final taf,tb_nsryhxx nsrxx,tb_nsryh nsr
				where nsr.nsryhxx_id = nsrxx.nsryhxx_id and tar.la_id=ta.la_id and taf.la_id=ta.la_id
				and nsrxx.nsryhxx_shtyxydm = ta.nsrsbh
				and nsr.enabled='Y' and tar.las_id ='DKZT03'
				<if test="province !=null and province !='' and city==null">
					and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		             and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		              and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="province!=null and city!= null and area !=null and area !='' ">
					 and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and unix_timestamp(DATE_FORMAT(ta.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
				</if>
				group by nsrxx.nsryhxx_swjgdm
				) c
				on tac.tax_id= c.nsryhxx_swjgdm) cal
				where tta.tax_id =cal.tax_pprc_id  and cal.swjbz=''
				group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot
				<if test="province !=null and province !='' and city==null">
					where substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
				</if>
				<if test="city !=null and city !='' and area==null">
					<if test="isChongQing != null and isChongQing == 'yes'">
		               where substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
		            <if test="isChongQing != null and isChongQing == 'no'">
		               where substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		            </if>
				</if>
				<if test="area !=null and area !='' ">
					where  substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
				</if>
				and tot.swjbz in('Y','K')) t
		group by t.taxid

		
		<!-- modify by xiecui 2018/04/02 end -->
		
		<!-- select tot.* from(
		select tta.tax_id taxid,tta.tax_name swjg,tta.swjbz,IFNULL(sum(cal.zcyh),0) zcyh,IFNULL(sum(cal.rztgs),0) rztgs,IFNULL(sum(cal.sxbs),0) sxbs,IFNULL(sum(cal.sxze),0) sxze 
		from tb_tax_authority_code tta,
		(select tac.tax_id taxid,tac.tax_prc_id,tac.tax_name swjg,a.zcyh,b.rztgs,c.sxze,c.sxbs,tac.swjbz from tb_tax_authority_code tac
		left join
		(select IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,nsrxx.nsryhxx_swjgdm,nsrxx.creatorid,nsrxx.nsryhxx_id 
		from tb_nsryhxx nsrxx 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			where date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		group by nsrxx.nsryhxx_swjgdm) a
		on tac.tax_id=a.nsryhxx_swjgdm
		left join
		(select IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,nsrxx.nsryhxx_swjgdm from tb_nsryhxx nsrxx,tb_nsryh nsr
		where nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
			and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		group by nsrxx.nsryhxx_swjgdm) b on tac.tax_id=b.nsryhxx_swjgdm
		left join
		(select round(IFNULL(sum(lar.lar_credit_quota),0),2) sxze,count(1) as sxbs,la.creatorid from tb_loan_approve_rec lar,tb_loan_apply la where 
		lar.la_id=la.la_id and las_id=3 and la.la_status in (3,7) 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(lar.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if>
		group by la.creatorid) c
		on a.creatorid= c.creatorid) cal
		where (tta.tax_id=cal.tax_prc_id and cal.swjbz='') or (tta.tax_id=cal.taxid and cal.swjbz in('Y','K'))
		group by tta.tax_id,tta.tax_name order by tta.tax_id asc) tot
		<if test="province !=null and province !='' ">
			where substring(tot.taxid,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
		</if>
		<if test="city !=null and city !='' "> 
			and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
		</if>
		<if test="city !=null and city !='' ">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(tot.taxid,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
		</if>
		<if test="area !=null and area !='' ">
			and substring(tot.taxid,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
		</if>
		and tot.swjbz in('Y','K') -->
		<!-- <if test="isChongQing != null and isChongQing == 'yes'">
			
		</if> -->
	</select>
	<!-- 银税互动，统计分析总表 -->
	<select id="reportingDetails" parameterType="map" resultMap="reportingMap" flushCache="true" useCache="true">
	<if test="currentarea=='province'.toString()">
		select cc.tax_id taxid,cc.tax_name swjg,sum(dd.zcyh) zcyh,sum(dd.rztgs) rztgs,sum(dd.sxbs) sxbs,sum(dd.sxze) sxze from tb_tax_authority_code cc,(
	</if>
		SELECT 
			tac.tax_id taxid,
			tac.tax_prc_id,
			tac.tax_name swjg,
			IFNULL(COUNT(DISTINCT nsrxx.nsryhxx_id),0) zcyh,
			IFNULL(COUNT(DISTINCT nsr.nsryh_id),0) rztgs,
			IFNULL(count(distinct lar.la_id),0) sxbs,
			round(IFNULL(sum(lar.lar_credit_quota),0),2) sxze
		FROM tb_tax_authority_code tac 
		LEFT JOIN tb_nsryhxx nsrxx ON nsrxx.nsryhxx_swjgdm=tac.tax_id
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and date_format(nsrxx.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
				and unix_timestamp(DATE_FORMAT(nsrxx.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
		</if>
		<if test="currentarea=='province'.toString()">
			LEFT JOIN tb_province_cities pc ON substring(tac.tax_id,2,2) = substring(pc.pc_code,1,2)
		</if>
		<if test="currentarea=='city'.toString()">
			LEFT JOIN tb_province_cities pc ON substring(tac.tax_id,2,4) = substring(pc.pc_code,1,4)
		</if>
		<if test="currentarea=='area'.toString()">
			LEFT JOIN tb_province_cities pc ON substring(tac.tax_id,2,6) = substring(pc.pc_code,1,6)
		</if>
		left join tb_nsryh nsr on nsr.nsryhxx_id = nsrxx.nsryhxx_id and nsr.enabled = 'Y' 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and date_format(nsr.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
				and unix_timestamp(DATE_FORMAT(nsr.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
		</if>
		left join tb_loan_apply la on la.creatorid=nsrxx.creatorid and la.la_status in ('DKZT03','DKZT07')
		left join tb_loan_approve_rec lar on lar.la_id=la.la_id and lar.las_id='DKZT03'
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and date_format(lar.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
				and unix_timestamp(DATE_FORMAT(lar.createtime, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime}) 
		</if>
		<choose>
            <when test="currentarea=='area'.toString()">
                   where pc.pc_id= #{pcId} 
                   <if test="isChongQing != null and isChongQing == 'no'">
                  	 and tac.swjbz='Y'
                   </if>
            </when>
            <otherwise>
                   <where>
	                   <if test="pcId != null and pcId != ''">
							pc.pc_pid= #{pcId} 
					       <if test="isChongQing != null and isChongQing == 'no'">
		                  	 	and tac.swjbz='Y'
		                   </if>
				       </if>
                   </where>
            </otherwise>
        </choose>
		GROUP BY tac.tax_id
		ORDER BY tac.tax_id ASC
		<if test="currentarea=='province'.toString()">
			) dd where  cc.tax_id = dd.tax_prc_id group by cc.tax_id,cc.tax_name
		</if>
	</select>


	<select id="unauthorizedDetails" parameterType="map" resultMap="reportingMap" flushCache="true" useCache="true">
		select 
			ifnull(count(n.nsryh_id),0) zcyh
		from tb_nsryh  n
			left join tb_regions r on r.region_id=n.region_id
			left join tb_province_cities pc on pc.pc_code=r.region_code
		<where>
			<if test="pcId != null and pcId != ''">
				pc.pc_pid= #{pcId}
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(n.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')		
			</if>
			and n.enabled ='K'
		</where> 
	</select>
	<select id="totalEnterprises" parameterType="map" resultMap="reportingMap" flushCache="true" useCache="true">
		select 
			ifnull(count(n.nsryh_id),0) zcyh
		from tb_nsryh  n
		<where>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(n.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')		
			</if>
		</where> 
	</select>
	<!-- 展示银税互动推进表 ,注册用户 -->
	<select id="detailUI" parameterType="java.util.Map" resultType="java.util.Map"> 
		<!-- SELECT 
			a.nsryh_id,
			a.enabled AS sfrz,
			a.createtime AS zcsj,
			b.nsryhxx_qymc AS qymc,
			b.nsryhxx_frmc AS frxm,
			b.nsryhxx_frsjh AS frsjh,
			b.nsryhxx_swjgdm,
			(SELECT cr.cr_dbqk from tb_check_record cr WHERE cr.creatorid=a.nsryh_id ORDER BY cr.cr_id DESC LIMIT 1) AS yy
		FROM 
			tb_nsryh a 
		LEFT JOIN 
			tb_nsryhxx b ON a.nsryh_id=b.creatorid
		left join 
			tb_tax_authority_code c on c.tax_id=b.nsryhxx_swjgdm
		WHERE b.nsryhxx_swjgdm=#{taxid} or c.tax_prc_id=#{taxid} 
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(a.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
				and date_format(b.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if> -->
<!-- 			1=1  -->
<!-- 			<if test="pro_area_city != null"> -->
<!-- 				and SUBSTR(b.nsryhxx_swjgdm,2,#{pro_area_city})=SUBSTR(#{pccode},1,#{pro_area_city}) -->
<!-- 			</if> -->
<!-- 			<if test="region_id != null"> -->
<!-- 				and a.region_id = #{region_id} and a.enabled = 'K' -->
<!-- 			</if> -->

<!-- SELECT
	IFNULL(T.ENTTAXID,0) nsryh_id,
	'Y' sfrz,
	IFNULL(T.ENTNAME,0) zcsj,
	IFNULL(T.INDNAME,0) qymc,
	IFNULL(T.INDCERTID,0) frxm,
	IFNULL(T.SQBS,0) frsjh,
	IFNULL(Y.SXBS,0) nsryhxx_swjgdm,
	IFNULL(Y.SXJE, 0) / 10000 yy
FROM
	(
		SELECT
			COUNT(DISTINCT A.BUSINESSID) SXBS,
			SUM(A.LOANAMOUNT) SXJE,
			A.ENTTAXID
		FROM
			tb_loan_dhsx A,
			(
				SELECT
					A.BUSINESSID,
					MAX(A.UPDATETIME) UPDATETIME
				FROM
					tb_loan_dhsx A
				GROUP BY
					A.BUSINESSID
			) B
		WHERE
			A.BUSINESSID = B.BUSINESSID
		AND A.UPDATETIME = B.UPDATETIME
		AND A.nsrzgswj = #{taxid}
	<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(A.`LOANGRANTTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
		GROUP BY
			A.BUSINESSID
	) Y
RIGHT JOIN (
	SELECT
		COUNT(DISTINCT A.BUSINESSID) SQBS,
		A.ENTNAME,
		A.INDNAME,
		A.INDCERTID,
		A.ENTTAXID
	FROM
		tb_loan_dksq A,
		(
			SELECT
				A.BUSINESSID,
				MAX(A.UPDATETIME) UPDATETIME
			FROM
				tb_loan_dksq A
			GROUP BY
				A.BUSINESSID
		) B
	WHERE
		A.BUSINESSID = B.BUSINESSID
	AND A.nsrzgswj = #{taxid}
	<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(A.`APPLYTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
	GROUP BY
		A.BUSINESSID
) T ON Y.ENTTAXID = T.ENTTAXID -->

SELECT
	IFNULL(T.ENTTAXID, 0) nsryh_id,
	'Y' sfrz,
	IFNULL(T.ENTNAME, 0) zcsj,
	IFNULL(T.INDNAME, 0) qymc,
	IFNULL(T.INDCERTID, 0) frxm,
	IFNULL(T.SQBS, 0) frsjh,
	IFNULL(Y.SXBS, 0) nsryhxx_swjgdm,
	IFNULL(Y.SXJE, 0) / 10000 yy
FROM
	(
		SELECT
			COUNT(DISTINCT A.BUSINESSID) SXBS,
			SUM(A.LOANAMOUNT) SXJE,
			A.ENTTAXID
		FROM
			v_tb_loan_dhsx A
		WHERE
			A.nsrzgswj = #{taxid}
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and A.`xzqhszdm` = #{area}
			</if>
	<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(A.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
GROUP BY A.BUSINESSID
	) Y
RIGHT JOIN (
	SELECT
		COUNT(DISTINCT A.BUSINESSID) SQBS,
		A.ENTNAME,
		A.INDNAME,
		A.INDCERTID,
		A.ENTTAXID
	FROM
		tb_loan_dksq A
	WHERE
		A.nsrzgswj = #{taxid}
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and A.`xzqhszdm` = #{area}
			</if>
	<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(A.`APPLYTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
GROUP BY A.BUSINESSID
) T ON Y.ENTTAXID = T.ENTTAXID
	</select>
	
	<!-- 展示银税互动推进表 ,认证通过 -->
	<select id="detailUIrztg" parameterType="java.util.Map" resultType="java.util.Map"> 
		<!-- SELECT 
			a.nsryh_id,
			a.createtime AS zcsj,
			b.nsryhxx_qymc AS qymc,
			b.nsryhxx_frmc AS frxm,
			b.nsryhxx_frsjh AS frsjh,
			b.nsryhxx_swjgdm 
		FROM 
			tb_nsryh a 
		LEFT JOIN 
			tb_nsryhxx b ON a.nsryh_id=b.creatorid
		left join 
			tb_tax_authority_code c on c.tax_id=b.nsryhxx_swjgdm
		WHERE a.enabled = 'Y' and (b.nsryhxx_swjgdm=#{taxid} or c.tax_prc_id=#{taxid})
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(a.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
				and date_format(b.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if> -->
<!-- 			1=1  -->
<!-- 			<if test="pro_area_city != null"> -->
<!-- 				and SUBSTR(b.nsryhxx_swjgdm,2,#{pro_area_city})=SUBSTR(#{pccode},1,#{pro_area_city}) -->
<!-- 			</if> -->
<!-- 			<if test="region_id != null"> -->
<!-- 				and a.region_id = #{region_id} and a.enabled = 'Y' -->
<!-- 			</if> -->

SELECT DISTINCT 
	IFNULL(a.BUSINESSID,0) nsryh_id,
	IFNULL(a.APPLYTIME,0) zcsj,
	IFNULL(a.ENTNAME,0) qymc,
	IFNULL(a.INDNAME,0) frxm,
	IFNULL(a.INDCERTID,0) frsjh,
	IFNULL(a.nsrzgswj,0) nsryhxx_swjgdm,
    IFNULL(a.LOANAPPLYAMOUNT,0)/10000 sqje
FROM
	tb_loan_dksq A
WHERE
	a.nsrzgswj = #{taxid}
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and A.`xzqhszdm` = #{area}
			</if>
	<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(A.`APPLYTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
	</select>
	
	<!-- 展示银税互动推进表 ,授信笔数 -->
	<select id="detailUIsxbs" parameterType="java.util.Map" resultType="java.util.Map">
		<!-- SELECT 
			org.org_name AS bankName,
			nsrxx.nsryhxx_qymc qymc,
			app.la_apply_time sdsj,
			app.la_amount sqed,
			sta.las_name spzt,
			rec.lar_credit_quota sxed,
			rec.lar_rate sxll,
			rec.lar_begin sxsj
		FROM tb_loan_apply app 
		LEFT JOIN tb_nsryhxx nsrxx ON nsrxx.creatorid=app.creatorid and app.la_status in ('DKZT03','DKZT07')
		LEFT JOIN tb_financial_product fp ON fp.fp_id=app.fp_id
		LEFT JOIN tb_loan_approve_status sta ON sta.las_id=app.la_status
		left join (select * from tb_loan_approve_rec where las_id='DKZT03') rec on rec.la_id=app.la_id
		LEFT JOIN tb_organizations org ON org.org_id=fp.org_id
		left join 
			tb_tax_authority_code c on c.tax_id=nsrxx.nsryhxx_swjgdm
		WHERE nsrxx.nsryhxx_swjgdm=#{taxid} or c.tax_prc_id=#{taxid}
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and date_format(a.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
				and date_format(b.createtime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
		</if> -->
<!-- 			1=1 -->
<!-- 			<if test="pro_area_city != null"> -->
<!-- 				and SUBSTR(nsrxx.nsryhxx_swjgdm,2,#{pro_area_city})=SUBSTR(#{pccode},1,#{pro_area_city}) -->
<!-- 			</if> -->
<!-- 			<if test="region_id != null"> -->
<!-- 				and app.region_id = #{region_id} -->
<!-- 			</if> -->


SELECT
	IFNULL(B.TBPNAME,0) AS bankName,
	IFNULL(B.ENTNAME,0) qymc,
	IFNULL(B.APPLYTIMESTART,0) sdsj,
	IFNULL(B.LOANAPPLYAMOUNT,0)/10000 sqed,
	IFNULL(B.LOANTERM,0) spzt,
	IFNULL(B.LOANAMOUNT,0)/10000 sxed,
	IFNULL(B.LOANBALANCE,0)/10000 sxll,
	IFNULL(B.LOANGRANTTIME,0) sxsj
FROM
	v_tb_loan_dhsx B
WHERE B.nsrzgswj = #{taxid}
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(B.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(B.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and B.`xzqhszdm` = #{area}
			</if>
<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	AND DATE_FORMAT(B.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
</if>
	
	</select>
	
	<!-- ***********************统计功能优化****************************** -->
	<select id="taxBankAnaDetails" parameterType="map" resultMap="reportingMap" flushCache="true" useCache="true">
		<!-- SELECT   a.taxid taxid,a.taxname swjg, a.swjbz swjbz, a.zcyh zcyh, a.rzyh rztgs , b.sxbs sxbs, b.sxze sxze FROM 
		(
		SELECT MAX(dqyh.`taxid`) taxid,MAX(dqyh.`taxname`) taxname,MAX(dqyh.swjbz) swjbz,IFNULL(SUM(dqyh.`zcyh`),0) zcyh,IFNULL(SUM(dqyh.`rzyh`),0) rzyh FROM `tb_statistics_dqyh` dqyh 
		<where>
			swjbz IN ('Y','K')
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(dqyh.`taxid`,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
				<if test="isChongQing != null and isChongQing == 'yes'">
	             and SUBSTRING(dqyh.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
	            <if test="isChongQing != null and isChongQing == 'no'">
	              and SUBSTRING(dqyh.`taxid`,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and SUBSTRING(dqyh.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(dqyh.`zcrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
		</where>
		GROUP BY dqyh.`taxid`
		)a,
		(
		SELECT MAX(dqdk.`taxid`) taxid,MAX(dqdk.`taxname`) taxname,IFNULL(SUM(dqdk.`sdbs`),0) sqdk,IFNULL(SUM(dqdk.`sxbs`),0) sxbs,IFNULL(SUM(dqdk.`sxze`),0) sxze FROM `tb_statistics_dqdk` dqdk 
		<where>
			swjbz IN ('Y','K')
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(dqdk.`taxid`,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
				<if test="isChongQing != null and isChongQing == 'yes'">
	             and SUBSTRING(dqdk.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
	            <if test="isChongQing != null and isChongQing == 'no'">
	              and SUBSTRING(dqdk.`taxid`,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
	            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and SUBSTRING(dqdk.`taxid`,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(dqdk.`sdrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
		</where>
		GROUP BY dqdk.`taxid`
		)b
		WHERE a.taxid=b.taxid -->
		
<!-- SELECT
	IFNULL(V.tax_id,0) taxid,
	IFNULL(V.tax_name,0) swjg,
	IFNULL(V.swjbz,0) swjbz,
	IFNULL(Y.DKYH,0) zcyh,
	IFNULL(Y.SQBS,0) rztgs,
	IFNULL(sxbs,0) sxbs,
	IFNULL(sxze, 0) / 10000 sxze
FROM
	(
		SELECT
			COUNT(DISTINCT A.ENTTAXID) DKYH,
			COUNT(DISTINCT A.BUSINESSID) SQBS,
			A.nsrzgswj
		FROM
			tb_loan_dksq A,
			(
				SELECT
					A.BUSINESSID,
					MAX(A.UPDATETIME) UPDATETIME
				FROM
					tb_loan_dksq A
				GROUP BY
					A.BUSINESSID
			) B
		WHERE
			A.BUSINESSID = B.BUSINESSID
		AND A.nsrzgswj IS NOT NULL
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    	AND DATE_FORMAT(A.`APPLYTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	    </if>
		GROUP BY
			A.nsrzgswj
	) Y
LEFT JOIN (
	SELECT
		COUNT(DISTINCT B.BUSINESSID) sxbs,
		SUM(B.LOANAMOUNT) sxze,
		B.nsrzgswj
	FROM
		tb_loan_dhsx B,
		(
			SELECT
				A.BUSINESSID,
				MAX(A.UPDATETIME) UPDATETIME
			FROM
				tb_loan_dhsx A
			GROUP BY
				A.BUSINESSID
		) C
	WHERE
		B.BUSINESSID = C.BUSINESSID
	AND B.UPDATETIME = C.UPDATETIME
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(B.`LOANGRANTTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
	GROUP BY
		B.nsrzgswj
) T ON Y.nsrzgswj = T.nsrzgswj
LEFT JOIN tb_tax_authority_code V ON Y.nsrzgswj = V.tax_id -->
	
SELECT
	IFNULL(V.tax_id, 0) taxid,
	IFNULL(V.tax_name, 0) swjg,
	IFNULL(V.swjbz, 0) swjbz,
	IFNULL(Y.DKYH, 0) zcyh,
	IFNULL(Y.SQBS, 0) rztgs,
	IFNULL(sxbs, 0) sxbs,
	IFNULL(sxze, 0) / 10000 sxze
FROM
	(
		SELECT
			COUNT(DISTINCT A.ENTTAXID) DKYH,
			COUNT(DISTINCT A.BUSINESSID) SQBS,
			A.nsrzgswj
		FROM
			tb_loan_dksq A
		WHERE
			a.nsrzgswj IS NOT NULL
			<if test="province !=null and province !='' and city==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null">
				and SUBSTRING(A.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and A.`xzqhszdm` = #{area}
			</if>
		<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    	AND DATE_FORMAT(A.`APPLYTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	    </if>
		GROUP BY
			A.nsrzgswj
	) Y
LEFT JOIN (
	SELECT
		COUNT(DISTINCT B.BUSINESSID) sxbs,
		SUM(B.LOANAMOUNT) sxze,
		B.nsrzgswj
	FROM
		v_tb_loan_dhsx B
	<where>
			<if test="province !=null and province !='' and city==null or city== ''">
				and SUBSTRING(B.`xzqhszdm`, 1, 2) = SUBSTRING(#{province}, 1, 2)
			</if>
			<if test="city !=null and city !='' and area==null or area== ''">
				and SUBSTRING(B.`xzqhszdm`, 1, 4) = SUBSTRING(#{city}, 1, 4)
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				 and B.`xzqhszdm` = #{area}
			</if>
	<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
	    AND DATE_FORMAT(B.`LOANTIME`,'%Y-%c-%d') BETWEEN DATE_FORMAT(#{starttime},'%Y-%c-%d') AND DATE_FORMAT(#{endtime},'%Y-%c-%d')
	</if>
	</where>
	GROUP BY
		B.nsrzgswj
) T ON Y.nsrzgswj = T.nsrzgswj
LEFT JOIN tb_tax_authority_code V ON Y.nsrzgswj = V.tax_id
	</select>
</mapper>