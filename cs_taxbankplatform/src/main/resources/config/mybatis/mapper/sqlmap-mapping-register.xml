<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.dkxx.mapper.RegisterMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>
	
	<resultMap id="registerEntity" type="com.dcits.govsbu.sd.taxbankplatform.gxgsService.model.RegisterModel">
		<id property="userId" column="nsryh_id"/>
		<result property="regionId" column="region_id" />
		<result property="loginId" column="ls_id" />
		<result property="nsryhxxId" column="nsryhxx_id" />
		<result property="qdcode" column="nsryh_qdcode" />
		<result property="enabled" column="enabled"/>
		<result property="city" column="region_name"/>
		<result property="userName" column="nsryh_name"/>
		<result property="password" column="nsryh_password"/>
		<result property="nsrmc" column="nsryhxx_nsrmc"/>
		<result property="zcdz" column="nsryhxx_zcdz"/>
		<result property="credentialsSalt" column="nsryh_credentials_salt"/>
		<result property="frmc" column="nsryhxx_frmc"/>
		<result property="qymc" column="nsryhxx_qymc"/>
		<result property="single" column="nsryhxx_nsrsbh"/>
		<result property="nsrsbh" column="nsryhxx_nsrsbh"/>
		<result property="phone" column="nsryhxx_zcsjh"/>
		<result property="djxh" column="nsryhxx_djxh"/>
		<result property="frsjh" column="nsryhxx_frsjh"/>
		<result property="papersName" column="nsryhxx_zjmc"/>
		<result property="papersNumb" column="nsryhxx_zjhm"/>
		<result property="rank" column="nsryhxx_xydj"/>
		<result property="content" column="si_content"/>
		<result property="swjgdm" column="nsryhxx_swjgdm"/>
		<result property="title" column="sc_name"/>
		<result property="yxs"  column="yxs"/>
	</resultMap>
	
	<!-- 根据纳税人识别号查账户 -->
	<select id="searchUserList" parameterType="com.dcits.govsbu.sd.taxbankplatform.dkxx.model.RegisterEntity" resultMap="registerEntity" flushCache="true" useCache="true">
		SELECT 
		n.nsryh_name,
		n.nsryh_id,
		n.region_id,
		n.nsryhxx_id,
		n.enabled,
		nx.nsryhxx_djxh,
		nx.nsryhxx_qymc,
		nx.nsryhxx_zcsjh,
		nx.nsryhxx_frsjh,
		nx.nsryhxx_nsrmc,
		nx.nsryhxx_frmc,
		nx.nsryhxx_xydj,
		nx.nsryhxx_zjmc,
		nx.nsryhxx_zjhm,
		nx.nsryhxx_swjgdm,
		r.region_name
		FROM tb_nsryh n LEFT JOIN tb_nsryhxx nx ON n.nsryhxx_id = nx.nsryhxx_id 
		LEFT JOIN tb_regions r ON n.region_id = r.region_id where nx.nsryhxx_zcsjh = #{frsjh} and nx.nsryhxx_nsrsbh = #{single}
	</select>
	
	<!-- 查询纳税人用户信息表ID -->
	<select id="findIdBySbh" resultMap="registerEntity" parameterType="String" flushCache="true" useCache="true">
		SELECT 
		nsryhxx_id,
		nsryhxx_zcsjh
		FROM tb_nsryhxx where nsryhxx_nsrsbh = #{nsrsbh}
	</select>
	
	<!-- 修改纳税人用户信息表-->
	<update id="updateNsryhxx" parameterType="com.dcits.govsbu.sd.taxbankplatform.dkxx.model.RegisterEntity" flushCache="true">
		update tb_nsryhxx 
		set
		nsryhxx_nsrsbh = #{single},
		nsryhxx_djxh = #{djxh},
		nsryhxx_nsrmc = #{nsrmc},
		nsryhxx_lpbm = #{lpbm},
		nsryhxx_zcdz = #{zcdz},
		nsryhxx_qymc = #{qymc},
		nsryhxx_frmc = #{frmc},
		nsryhxx_frsjh = #{frsjh},
		nsryhxx_xydj = #{rank},
		nsryhxx_hydm = #{hydm},
		nsryhxx_zjmc = #{papersName},
		nsryhxx_zjhm = #{papersNumb},
		nsryhxx_swjgdm = #{swjgdm},
		nsryhxx_zczb = #{zczb},
		nsryhxx_jyfw = #{jyfw},
		nsryhxx_djrq = #{clsj},
		nsryhxx_zgswjdm = #{zgswjdm},
		nsryhxx_yxqq = #{yxqq},
		nsryhxx_yxqz = #{yxqz},
		updatorid = #{updatorid},
		updatetime = now()
		where nsryhxx_id = #{id}
	</update>

	<!-- 根据用户id查询用户信息  -->
	<select id="findById" parameterType="String" resultMap="registerEntity" flushCache="true" useCache="true">
		select nh.nsryh_name,nh.region_id,nh.enabled,nhx.nsryhxx_djxh,nhx.nsryhxx_nsrsbh,nhx.nsryhxx_swjgdm,nhx.nsryhxx_qymc,nhx.nsryhxx_zcdz,nhx.nsryhxx_nsrmc,nhx.nsryhxx_frmc,nhx.nsryhxx_zcsjh,nhx.nsryhxx_frsjh,nhx.nsryhxx_zjmc,nhx.nsryhxx_zjhm,nhx.nsryhxx_xydj,nh.nsryh_name,nh.nsryh_password,reg.region_name 
		from tb_nsryh nh,tb_nsryhxx nhx,tb_regions reg where nh.region_id = reg.region_id
		and nh.nsryhxx_id = nhx.nsryhxx_id
		and nh.nsryh_id = #{id}
	</select>
	
	<!-- 根据纳税人识别号查账户 -->
	<select id="UserList" parameterType="map" resultMap="registerEntity" flushCache="true" useCache="true">
		SELECT 
		n.nsryh_name,
		n.nsryh_id,
		n.region_id,
		n.nsryhxx_id,
		n.enabled,
		nx.nsryhxx_nsrsbh,
		nx.nsryhxx_djxh,
		nx.nsryhxx_qymc,
		nx.nsryhxx_zcsjh,
		nx.nsryhxx_frsjh,
		nx.nsryhxx_nsrmc,
		nx.nsryhxx_frmc,
		nx.nsryhxx_xydj,
		nx.nsryhxx_zjmc,
		nx.nsryhxx_zjhm,
		nx.nsryhxx_swjgdm

		FROM tb_nsryh n LEFT JOIN tb_nsryhxx nx ON n.nsryhxx_id = nx.nsryhxx_id  
		<where>    
		<if test=" isy == 'ynsrsbh' ">
	    and nx.nsryhxx_nsrsbh=#{nsrsbh}
	    </if>
		<if test=" isy =='nnsrsbh' ">
	    and nx.nsryhxx_shtyxydm=#{nsrsbh}
	    </if>
	    <if test="userid != null and userid!='' ">
	      n.nsryh_id=#{userid}
	    </if>
	    </where>
	
	</select>
	
	<update id="updatehtzt"  parameterType="map"  flushCache="true">
	      
	      update  tb_nsryh yh 
          <set>
             yh.updatetime = date_format( date_format(now(), '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
             <if  test="yxs!=null and ysx!=''">
               ,yh.yxs=#{yxs}
             </if>
             
          </set>
          where yh.nsryh_id=#{nsryhid}
	      
	</update>
	
	<!-- 通过纳税人识别号查询认证通过的用户名 -->
	<select id="searchYByNsrsbh" resultType="String" parameterType="map" flushCache="true" useCache="true">
		SELECT n.nsryh_name
		from tb_nsryh n, tb_nsryhxx nx
		where (n.nsryhxx_id = nx.nsryhxx_id and n.enabled = "Y" and n.yxs = "Y" and nx.nsryhxx_shtyxydm = #{crNsrsbh})
		or (n.nsryhxx_id = nx.nsryhxx_id and n.enabled = "Y" and n.yxs = "Y" and nx.nsryhxx_nsrsbh = #{nsrsbh})
		order by n.updatetime desc
		limit 1
	</select>
	
	<!-- 用户登录 -->
	<select id="userLogin" parameterType="String" resultMap="registerEntity" flushCache="true" useCache="true">
		SELECT 
		n.nsryh_name,
		n.nsryh_id,
		n.region_id,
		n.nsryhxx_id,
		n.nsryh_qdcode,
		n.nsryh_password,
		n.nsryh_credentials_salt,
		n.enabled,
		nx.nsryhxx_djxh,
		nx.nsryhxx_qymc,
		nx.nsryhxx_nsrsbh,
		nx.nsryhxx_zcsjh,
		nx.nsryhxx_frsjh,
		nx.nsryhxx_nsrmc,
		nx.nsryhxx_frmc,
		nx.nsryhxx_xydj,
		nx.nsryhxx_zjmc,
		nx.nsryhxx_bsysjh,
		nx.nsryhxx_zjhm,
		nx.nsryhxx_swjgdm,
		r.region_name
		FROM tb_nsryh n LEFT JOIN tb_nsryhxx nx ON n.nsryhxx_id = nx.nsryhxx_id 
		LEFT JOIN tb_regions r ON n.region_id = r.region_id where n.nsryh_name = #{userName}
		ORDER BY n.createtime DESC LIMIT 1
	</select>
	
	<!-- 插入用户信息表数据 -->
	<insert id="insertUserInfo" parameterType="com.dcits.govsbu.sd.taxbankplatform.gxgsService.model.RegisterModel">
		insert into tb_nsryhxx (
			nsryhxx_id,nsryhxx_djxh,nsryhxx_shtyxydm,nsryhxx_nsrsbh,nsryhxx_zcsjh,nsryhxx_nsrmc,nsryhxx_zcdz,nsryhxx_qymc,nsryhxx_frmc,nsryhxx_xydj,nsryhxx_zjmc,nsryhxx_zjhm,
			nsryhxx_swjgdm,nsryhxx_bsysjh,creatorid,createtime,updatorid,updatetime,nsryhxx_zgswjdm
			)   
		values (
			#{nsryhxxId},
			#{djxh},
			#{nsrsbh},
			#{shtyxydm},
			#{phone},
			#{nsrmc},
			#{zcdz},
			#{qymc},
			#{frmc},
			#{rank},
			#{papersName},
			#{papersNumb},
			#{swjgdm},
			#{bsysjh},
			#{userId},
			now(),
			#{userId},
			now(),
			#{zgswjdm}
			) 
	</insert>
	
	<!-- 插入用户表数据 -->
	<insert id="insertUser" parameterType="com.dcits.govsbu.sd.taxbankplatform.gxgsService.model.RegisterModel">
		insert into tb_nsryh (
			nsryh_id,region_id,nsryhxx_id,nsryh_qdcode,nsryh_name,nsryh_password,nsryh_credentials_salt,enabled,yxs,creatorid,createtime,updatorid,updatetime
			)   
		values (
			#{userId},
			#{regionId},
			#{nsryhxxId},
			#{qdcode},
			#{userName},
			#{password},
			#{credentialsSalt},
			#{enabled},
			"K",
			#{userId},
			now(),
			#{userId},
			now()
			) 
	</insert>
</mapper>