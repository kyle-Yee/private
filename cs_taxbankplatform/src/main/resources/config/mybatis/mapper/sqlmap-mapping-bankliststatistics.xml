<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.mapper.BankliststatisticsMapper">
	<!--mybatis ehcache缓存配置,以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志  -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/> 
	
	<resultMap id="bankliststatisticsMap" type="com.dcits.govsbu.sd.taxbankplatform.regulatorstatistics.model.BanklistInfoEntity">
		<result property="bankName" column="bankname" />
		<result property="dksqbs" column="dksqbs" />
		<result property="dksqze" column="dksqze" />
		<result property="pjsdje" column="pjsdje" />
		<result property="cgsxbs" column="cgsxbs" />
		<result property="cgsxed" column="cgsxed" />
		<result property="pjsxed" column="pjsxed" />
	</resultMap>
	
	<select id="bankliststatistics_bef" parameterType="map" resultMap="bankliststatisticsMap" flushCache="true" useCache="true">
		<!-- modify by xiecui 2018/04/02 begin -->
		<!-- select apprec.bankname,ifnull(apprec.dksqbs,0) dksqbs,ifnull(apprec.dksqze,0) dksqze,
		ifnull(apprec.pjsdje,0) pjsdje,ifnull(authrec.cgsxbs,0) cgsxbs,ifnull(authrec.cgsxed,0) cgsxed,ifnull(authrec.pjsxed,0) pjsxed
		from
(select 
            org.org_id,
				max(org.org_name) bankname,
				ifnull(count(distinct la.la_id),0) dksqbs,
				ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
				FORMAT(ifnull(sum(la.la_amount)/count(la.la_id),0),2) pjsdje 
			from  
				tb_organizations org,	
			   tb_financial_product fp,
			   tb_loan_apply la,
				tb_nsryhxx nsrxx,
				tb_nsryh nsr
				where fp.org_id=org.org_id and la.fp_id=fp.fp_id 
				and nsr.nsryhxx_id = nsrxx.nsryhxx_id
				and ((la.nsrsbh=nsrxx.nsryhxx_nsrsbh and la.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = la.nsrsbh and la.nsrsbh!=''))
			  and  nsr.enabled='Y' and org.ot_id='ZZLX002'
			  <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			 	and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			 </if>
			 <if test="province !=null and province !='' and city==null">
				and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			group by org.org_id) apprec
			left join	
			(select 
			org.org_id,
			ifnull(count(distinct la.la_id) ,0) cgsxbs,
		   ROUND(ifnull(sum(tar.lar_credit_quota),0) , 2) cgsxed,
			FORMAT(ifnull(sum(tar.lar_credit_quota)/count(la.la_id),0),2) pjsxed   
			from  
				tb_organizations org	,	
			   tb_financial_product fp,
			   tb_loan_apply la,
				tb_loan_approve_rec tar,
				tb_nsryhxx nsrxx,
				tb_nsryh nsr,
				tb_loan_apply_final taf
				where fp.org_id=org.org_id and la.fp_id=fp.fp_id 
			   and la.la_id = tar.la_id 
				and nsr.nsryhxx_id = nsrxx.nsryhxx_id
				and ((la.nsrsbh=nsrxx.nsryhxx_nsrsbh and la.nsrsbh!='') or (nsrxx.nsryhxx_shtyxydm = la.nsrsbh and la.nsrsbh!=''))
				and taf.la_id=la.la_id
			  and  nsr.enabled='Y' and tar.las_id ='DKZT03' and org.ot_id='ZZLX002'
			  <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
			 	and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			 </if>
			 <if test="province !=null and province !='' and city==null">
				and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			 group by org.org_id) authrec
			 on apprec.org_id = authrec.org_id
			<if test="bank !=null and bank !='' " >
			    	where  apprec.bankname like CONCAT('%',#{bank},'%')
			 </if> -->
			
			
			select apprec.bankname,ifnull(apprec.dksqbs,0) dksqbs,ifnull(apprec.dksqze,0) dksqze,
		ifnull(apprec.pjsdje,0) pjsdje,ifnull(authrec.cgsxbs,0) cgsxbs,ifnull(authrec.cgsxed,0) cgsxed,ifnull(authrec.pjsxed,0) pjsxed
		from
		(select max(t.orgid) orgid,max(t.bankname) bankname,sum(t.dksqbs) dksqbs ,sum(t.dksqze) dksqze,sum(t.pjsdje) pjsdje 
		from (select 
          		org.org_id orgid,
				max(org.org_name) bankname,
				ifnull(count(distinct la.la_id),0) dksqbs,
				ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
				FORMAT(ifnull(sum(la.la_amount)/count(la.la_id),0),2) pjsdje 
			from  
				tb_organizations org,	
			   tb_financial_product fp,
			   tb_loan_apply la,
				tb_nsryhxx nsrxx,
				tb_nsryh nsr
				where fp.org_id=org.org_id and la.fp_id=fp.fp_id 
				and nsr.nsryhxx_id = nsrxx.nsryhxx_id
				and la.nsrsbh=nsrxx.nsryhxx_nsrsbh 
			  and  nsr.enabled='Y' and org.ot_id='ZZLX002'
			  <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
			 	and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			 </if>
			 <if test="province !=null and province !='' and city==null">
				and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			group by org.org_id
			
			union all
			select 
          		org.org_id orgid,
				max(org.org_name) bankname,
				ifnull(count(distinct la.la_id),0) dksqbs,
				ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
				FORMAT(ifnull(sum(la.la_amount)/count(la.la_id),0),2) pjsdje 
			from  
				tb_organizations org,	
			   tb_financial_product fp,
			   tb_loan_apply la,
				tb_nsryhxx nsrxx,
				tb_nsryh nsr
				where fp.org_id=org.org_id and la.fp_id=fp.fp_id 
				and nsr.nsryhxx_id = nsrxx.nsryhxx_id
				and nsrxx.nsryhxx_shtyxydm = la.nsrsbh 
			  and  nsr.enabled='Y' and org.ot_id='ZZLX002'
			  <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
			 	and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			 </if>
			 <if test="province !=null and province !='' and city==null">
				and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			group by org.org_id) t
			group by t.orgid
			) apprec
			
			left join	
			(select max(t.orgidb) orgidb, sum(t.cgsxbs) cgsxbs,sum(t.cgsxed) cgsxed,sum(t.pjsxed) pjsxed from (
			select 
			org.org_id orgidb,
			ifnull(count(distinct la.la_id) ,0) cgsxbs,
		   ROUND(ifnull(sum(tar.lar_credit_quota),0) , 2) cgsxed,
			FORMAT(ifnull(sum(tar.lar_credit_quota)/count(la.la_id),0),2) pjsxed
			from  
				tb_organizations org	,	
			   tb_financial_product fp,
			   tb_loan_apply la,
				tb_loan_approve_rec tar,
				tb_nsryhxx nsrxx,
				tb_nsryh nsr,
				tb_loan_apply_final taf
				where fp.org_id=org.org_id and la.fp_id=fp.fp_id 
			   and la.la_id = tar.la_id 
				and nsr.nsryhxx_id = nsrxx.nsryhxx_id
				and la.nsrsbh=nsrxx.nsryhxx_nsrsbh 
				and taf.la_id=la.la_id
			  and  nsr.enabled='Y' and tar.las_id ='DKZT03' and org.ot_id='ZZLX002'
			  <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
			 	and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			 </if>
			 <if test="province !=null and province !='' and city==null">
				and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			 group by org.org_id
			 
			 union all
			 select 
			org.org_id,
			ifnull(count(distinct la.la_id) ,0) cgsxbs,
		   ROUND(ifnull(sum(tar.lar_credit_quota),0) , 2) cgsxed,
			FORMAT(ifnull(sum(tar.lar_credit_quota)/count(la.la_id),0),2) pjsxed
			from  
				tb_organizations org	,	
			   tb_financial_product fp,
			   tb_loan_apply la,
				tb_loan_approve_rec tar,
				tb_nsryhxx nsrxx,
				tb_nsryh nsr,
				tb_loan_apply_final taf
				where fp.org_id=org.org_id and la.fp_id=fp.fp_id 
			   and la.la_id = tar.la_id 
				and nsr.nsryhxx_id = nsrxx.nsryhxx_id
				and nsrxx.nsryhxx_shtyxydm = la.nsrsbh
				and taf.la_id=la.la_id
			  and  nsr.enabled='Y' and tar.las_id ='DKZT03' and org.ot_id='ZZLX002'
			  <if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				<!-- and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d') -->
			 	and unix_timestamp(DATE_FORMAT(la.la_apply_time, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			 </if>
			 <if test="province !=null and province !='' and city==null">
				and substring(nsrxx.nsryhxx_swjgdm,2,2) in(select substring(pc.pc_code,1,2) from  tb_province_cities pc where pc.pc_id = #{province})
			</if>
			<if test="city !=null and city !='' and area==null">
			<if test="isChongQing != null and isChongQing == 'yes'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
            <if test="isChongQing != null and isChongQing == 'no'">
                  and substring(nsrxx.nsryhxx_swjgdm,2,4) in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
            </if>
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and substring(nsrxx.nsryhxx_swjgdm,2,6) in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			 group by org.org_id) t
			 group by t.orgidb
			 ) authrec
			 on apprec.orgid = authrec.orgidb
			<if test="bank !=null and bank !='' " >
			    	where  apprec.bankname like CONCAT('%',#{bank},'%')
			 </if>
			 
			 <!-- modify by xiecui 2018/04/02 end -->
			<!-- select 
				max(org.org_name) bankname,
				ifnull(count(la.la_id),0) dksqbs,
				ROUND(ifnull(sum(la.la_amount),0) , 2) dksqze,
				FORMAT(ifnull(sum(la.la_amount)/count(la.la_id),0),2) pjsdje,
				ifnull(count(B.laid) ,0) cgsxbs,
				ROUND(ifnull(sum(B.lar_credit_quota),0) , 2) cgsxed,
				FORMAT(ifnull(sum(B.lar_credit_quota)/count(B.laid),0),2) pjsxed   
			from  
				tb_organizations org		
				join tb_financial_product fp on fp.org_id=org.org_id
				left join tb_loan_apply la on la.fp_id=fp.fp_id
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and  date_format(la.la_apply_time, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
				</if>
				left join (Select 
								A.* 
							from 
								(Select max(lar1.la_id) laid,
										lar1.lar_id,
										lar1.region_id,
										lar1.fp_id,
										lar1.la_id,
										lar1.las_id,
										lar1.lafs_id,
										lar1.lac_id,
										lar1.lar_credit_quota,
										lar1.lar_loan_deadline,
										lar1.lar_begin,
										lar1.lar_end,
										lar1.lar_isoverlay_area,
										lar1.updatetime
									From tb_loan_approve_rec lar1
									Where  lar1.las_id=3
									Group by  lar1.la_id) as A 
										join tb_loan_apply la1 on A.laid=la1.la_id
										join tb_regions on tb_regions.region_id=la1.region_id
										join tb_province_cities on tb_province_cities.pc_code=tb_regions.region_code
							) B
							on B.laid=la.la_id 
				<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
					and  date_format(B.updatetime, '%Y-%c-%d') between date_format(#{starttime}, '%Y-%c-%d') and date_format(#{endtime}, '%Y-%c-%d')
				</if>
				join tb_province_cities pc on pc.pc_id=org.pc_id
			<where>
			   	<if test="pcId !=null and pcId !='' ">
					 ( pc.pc_id = #{pcId} or pc.pc_pid = #{pcId}
					or pc.pc_pid in (select pcs.pc_id from tb_province_cities pcs where pcs.pc_pid = #{pcId} ))
				</if>

			    <if test="bank !=null and bank !='' " >
			    	and org.org_name = #{bank}
			    </if>
			    	  and  org.ot_id=2
			</where>
			group by org.org_id -->
	</select>
	<select id="bankliststatistics" parameterType="map" resultMap="bankliststatisticsMap" flushCache="true" useCache="true">
		SELECT bl.`bankname`,  SUM(bl.`dksqbs`) dksqbs,SUM(bl.`dksqze`) dksqze,FORMAT(IFNULL(SUM(bl.`dksqze`) / SUM(bl.`dksqbs`), 0),2) pjsdje,SUM(bl.`cgsxbs`) cgsxbs,SUM(bl.`cgsxed`) cgsxed,FORMAT(IFNULL(SUM(bl.`cgsxed`) / SUM(bl.`cgsxbs`), 0),2) pjsxed FROM`tb_statistics_banklist` bl 
		<where>
			<if test="starttime !=null and starttime!= '' and endtime != null and endtime != ''">
				and unix_timestamp(DATE_FORMAT(bl.`tjrq`, '%Y-%m-%d')) between unix_timestamp(#{starttime}) and  unix_timestamp(#{endtime})
			</if>
			<if test="province !=null and province !=''">
				and bl.`swjgdm_p` like CONCAT('%',#{province},'%')
			</if>
			<if test="city !=null and city !='' and province !=null">
			   
				<if test="isChongQing != null and isChongQing == 'yes'">
					and bl.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{city})
				</if>
				<if test="isChongQing != null and isChongQing == 'no'">
					and bl.`swjgdm_c` in(select substring(pc.pc_code,1,4) from  tb_province_cities pc where pc.pc_id = #{city})
				</if>
				 and bl.`swjgdm_c`=#{city}
			</if>
			<if test="province!=null and city!= null and area !=null and area !='' ">
				and bl.`swjgdm_a` in(select substring(pc.pc_code,1,6) from  tb_province_cities pc where pc.pc_id = #{area})
			</if>
			<if test="bank !=null and bank !='' " >
			    and bl.`bankname` like CONCAT('%',#{bank},'%')
			</if>
		</where>
		GROUP BY bl.`bankName`
	</select>
</mapper>